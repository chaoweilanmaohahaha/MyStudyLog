# linux 引导部分解析

这一部分主要介绍linux0.11内核版本下，系统是如何将内核加载进来，有关内核的引导程序的介绍。

关于linux引导部分的代码在boot文件夹下主要包括bootsect.s,setup.s,head.s三个文件来完成。前两者都是使用x86的汇编书写，head.s采用AT&T风格汇编来书写，因此在编译过程中，前两者采用as86来进行编译，而后者采用gas来进行。**为什么要用两种不同的汇编格式的文件来写呢，那是因为当时gas还不能支持16位汇编代码程序，而在实模式下需要运行16位代码的程序，因此只能借助as86来进行。**

当电脑开机时，计算机默认运行在实模式下（寻址空间1M），存储在ROM-BIOS的程序会对系统进行检测，然后从物理地址0处开始初始化中断向量。随后它将可用于引导的设备的第一个扇区也就是所谓引导扇区，也就是存在的bootsect.s代码默认加载到0x7C00处，随后运行该代码。

#### bootsect.s在干嘛

这段代码驻留在磁盘第一个扇区，它的第一步是将自己移动到内存0x90000处，然后它会将setup.s代码通过13号中断从磁盘加载到它的后面也就是内存地址0x90200处，再读取引导盘的参数，将system模块，也就是带有内核代码和head.s的模块移动到内存地址开始的0x10000（64KB）处，当时的内核保证代码长度（512KB）不会覆盖到bootsect.s,这也是为什么要把自己搬一下位置，在腾空间呢！当做完这些后，长跳转到setup执行它的代码。在这个版本的代码中默认给出的是从1.44M或者是1.2M软盘启动的，如果需要使用硬盘，可启动硬盘的第 1 个扇区（主引导记录 MBR - Master Boot Record）会被 BIOS 加载到内存 0x7c00 处并开始执行。该程序会首先把自己向下移动到内存 0x600 处， 然后根据 MBR 中分区表信息所指明的活动分区中的第 1 个扇区（引导扇区）加载到内存 0x7c00 处，然 后开始执行之。 

**这个里面有一个相对重要的细节，就是在该段的508字节应该存放了跟文件设备号信息，而系统中默认设置的根文件系统位置是第二个硬盘的第一个分区，如果没找到的话需要另行判断。**

感觉哈这个里面因为设计很多读写磁盘的操作，还是有必要了解一下13号中断的。

#### setup.s在干嘛

setup的代码从0x90200开始，它首先要从系统中读取系统参数，并保存在0x90000开始的内存区域中，也就是覆盖上面的bootsect.s，然后它将system模块下移到物理地址0x00000处，随后使用lgdt和lidt加载gdt(全局描述符表）和idt（中断描述符表），然后开启A20地址线才能访问到1M之上的地址（这个是因为计算机的发展，存储空间的扩展导致寻址空间要发生变化，而地址线也要跟着变，这里因为马上就要进入保护模式了，寻址空间要发生变化了，而老式电脑的寻址空间很小。），随后重新设置中断控制芯片8259，设置中断int0x20到0x2f，因为默认使用的中断和系统预留的中断起了冲突，最后通过设置CPU控制寄存器CR0进入32位保护模式。这里有一个细节，就是程序最后的jmp 0，8 ,这个加载了接下去跳转的代码段基地址，指向的正好是物理地址0处，也就是正好是head.s的入口处。

在这中间用到了15号中断和10号中断值得了解。

同时有几个问题还是要想一下，在这一步中允许system模块移动到物理地址0处是因为在这一步中重新设置了中断了，因此接下来不需要使用BIOS提供的中断了，在此之前仍需使用其中的数据所以不能覆盖。这里设置了gdt和idt是给截下来运行的head.s临时创建使用的，这一点需要注意。

#### head.s在干嘛

head.s主要的工作是在分页，此时系统运行在了保护模式下了，那么在head.s中需要重新再设置一次gdt（和setup中设置的表一样）和idt（真正重新设置中断描述符表，256个表项，但是其中的中断都设置为哑中断）这是以后真正要用到的。随后进行必要的硬件检测，然后置为CR0中的GP位，告诉系统要进行分页的操作，然后开始分页，使用CR3寄存器指向页目录表。在程序的最后是有一个小trick的，那就是当分页函数ret的时候需要执行截下来的系统初始化函数main.c，则在执行之前需要将main.c压入堆栈中，当函数返回时默认弹出main.c,然后开始进行初始化。注意这个程序里面最后存放页表的位置，会覆盖head.s的执行代码，也就是最后的形态会是页目录项从物理地址0处开始，随后以此存放四个4K的页表。

![kernel1](..\..\img\kernel1.png)

#### 以上就是系统的引导过程啦！！

**在实模式下，段寄存器中存放的是内存段的基地址，而内存段的大小默认是64KB，因此段内寻址最大也就是64KB，但是在保护模式下段寄存器存放的是段选择符。**

![kernel2](..\..\img\kernel2.png)