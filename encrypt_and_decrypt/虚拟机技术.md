# 虚拟化技术(VT)

VT 是 Intel 硬件辅助虚拟化技术，一开始是为了提高 VMware 相关的软件虚拟化，它引入了一个新的 CPU 层级 Ring -1。

新的 CPU 模式和虚拟化指令能够帮助 VMM 提升性能。Intel 的 VT 技术专门为 CPU 提供了**虚拟机扩展功能(VMX)**，在这里 CPU 模式为 root 模式，专门给 VMM 使用。当子操作系统(Guest OS) 运行在 non-Root 模式下时，VMM 可以截获 Guest OS 使用的特权指令和对硬件的访问。

VMM 通过虚拟机控制结构来设置需要解惑硬件访问。如果子系统触发了这些条件，就会引发 VMExit，CPU 切换到 Root 模式由 VMM 控制系统并执行程序。执行结束后执行 VMEntry，然后返回子系统。

VMM 也称为 Hypervisor，这个的意思专门指 VT 技术创建的特权层。**这个层面能够监控计算机各个行为，所以这个层面的权限是大于操作系统的。**

典型的使用 Hypervisor 的例子有以下 4 步：

1. 分配 VMXON 区域和 VMCS 控制块
2. 填写 VMCS 控制块
3. 调用 VMXLaunch 指令启动虚拟机
4. 当产生 VMExit 事件时调用 VMExitProc 函数，处理事件。

实现 VT 技术就需要引入一套新的指令集， VMXOn 用来开启 VMX 操作模式，当然与之对应有一个关闭。VMLaunch 指令就是从 Hypervisor 进入到 Guest OS 模式下。VMCS 的目的就是唯一标识一个子系统，所以它是比较关键的一个结构。总结一下引入了如下这些指令：

![VT](..\img\VT.png)

我们非常关心 VMCS 的数据区，这个区域保存了虚拟机的各种状态和行为，所以这个区域一共分为了六个部分：

* 虚拟机状态域：从这个区域加载虚拟机各种状态值。
* 宿主机状态域：在发生 VMExit 时，处理器的状态从这个域加载，这个里面只存储了相关的寄存器信息。
* 虚拟机执行控制域：在这里设置退出条件，控制处理器在非 Root 模式中的行为，以及哪些事件会导致 VMExit 事件陷入 Hypervisor。
* 虚拟机 VMEntry 控制域：就是在进入子系统时应该发生的事件，可以在这里设置。
* 虚拟机 VMExit 控制域：这个是定义了 VM Exit 事件发生后硬件立即要做的事情，分别为 VMC 和 VMEC for MSRs。
* 虚拟机 VMExit 信息域：这个区域是只读区域，包含最近的 VMExit 事件的相关信息，描述虚拟机退出的原因。

## EPT 机制

为了支持物理隔离并且提高虚拟机的执行效率，则引入了扩展页表技术(EPT)，这使得每个子系统都有独立的物理地址空间，有点和进程类似。

当开启了这个机制之后，子系统通过 CR3 转换出来的物理地址，然后通过 EPT 机制转换成真实的物理地址空间。

EPT 页表可以最多包含 4 级页表的形式，这个和分页机制一样。一般出现却也异常时会有两种故障，EPT Violation 和 EPT Misconfiguration。

## VT 技术的运用

当数据访问时访问某个物理地址内容，而代码执行时指向了物理地址的内容，通过 VT 技术的 EPT 机制，就可以对数据和代码进行不同的映射，这实现了内存隐藏的目的。

对于一个 Hypervisor 内核谋爱的大致功能是在 DriverEntry 中检测 CPU 对 VT 的支持情况，然后配置 VMCS 和 EPT 信息，开启了 VT 然后通过 cpuid 测试 VT 效果。

开启 VT 之后，VT 模块通过调用系统历程 PsSetCreateProcessNotifyRoutine 注册一个进程创建回调，然后监视进程的创建。当监视到某进程创建后，需要在内存中进行复制，一份作为数据访问，一份作为代码执行。

在 Hypervisor 中，可以通过调用 CheckVtSupport 函数来检测当前机器是否开启了 VT。当所有需要检查的条件都符合要求的时候，会将 CR4.VMXE 置位，此时才能执行后续的指令。

随后需要为每个 CPU 分配一个 CONTEXT 结构，存放一些类似 VMCS、EPT 的结构，随后进入 Root 模式。这里就是要填写 VMCS 的六个域。

在 Hypervisor 中，配置 EPT 是关键的一步，它需要设置 EPT 指针并初始化 EPT 页表。

当以上的步骤都完成了，就可以正式执行 VMLaunch 指令，开启 VT 了。

> 以上的这些片段摘自书本，详细内容和操作还是要看一下书本。因为这部分牵涉太多代码，这里只不过介绍了一下简单的过程。

## VT 调试

使用 VMware 配合了 WinDbg 和 IDA Pro 进行 VT 的调试将使调试 VT 模块将变得很简单。

搭建双机调试的环境之后，只要使用 WinDbg 打下断点，就可以开始调试。但是这样的调试是无法调试 VT 以后 Root 模式的代码的，那么如果要想进入 Hypervisor 的代码，需要使用 IDA Pro 配合 VMware 的调试需要的 GDB Stub。

这样使用 IDA Pro 可以远程调试 Root 模式下的代码，而 WinDbg 可以调试 non-Root 下的代码。

> 以上内容暂时先这样吧，感觉不实际操作一下并不能理解上面提到的步骤。