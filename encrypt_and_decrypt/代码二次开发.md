# 代码二次开发

如果已经有了对方程序的源代码，那也没必要讨论代码二次开发的问题。但是很多情况下都是闭源代码，没有源码没有接口。也就是说目标文件是二进制 EXE 或者 DLL。这个技术一般称为 PEDIY 技术。下面看看可能用到的一些技术吧。

## 数据对齐

数据对齐是针对 CPU 的一种做法。**注意数据对齐的意思是，当数据大小的数据模数的内存地址是 0 时，数据就是对齐的(WORD 被 2 除尽的地址开始)。**Windows 中必须按照 4 字节对齐，这样才能提高执行效率。

## 增加空间

二次开发中需要在目标程序中增加一些功能，需要一些空间来存放代码。

### 区块间隙

如果代码量并不是特别多，则可以存放在区块与区块之间的间隙中。每个区块都会等于磁盘对齐值的整数倍，但是区块实际的数据不可能那么多就会用 00  填充。

### 构造区块

如果需要添加的代码量比较大，则可以增加一个区块，这需要熟悉 PE 格式。注意增加区块的三个工作：

* 增加块头
* 增加块头指向的数据段
* 调整文件映像的尺寸

### 使用工具辅助构造

* LoadPE
* CFF Explore

## 获得函数调用信息

扩充程序的功能时，可能需要调用的 API 函数不在输入表中，则要么需要修改输入表结构；要么用显示链接的方式调用 DLL。

这里的方法在之前的其他注入技术中已经提到了。

## 代码重定位

在 PE 文件里，涉及到直接寻址的指令都需要重定位。这里主要是对于 DLL 动态链接库文件来说的，在修补 DLL 文件时必须要提供重定位的代码。

重定位信息是由编译器生成的，并且保留在 PE 文件的重定位表里。如果程序里增加了需要重定位的代码是需要在重定位表里增加新的项。

### 代码自定位技术

不通过重定位表也可以实现代码重定位，利用 call 指令执行时会将返回地址压入栈中然后 pop 的原理，实现代码自定位。(也就是在代码中就计算出代码之间的偏移量)

## 增加输出函数

一般情况下若需要实现某个函数的功能，可以重写一个 DLL 文件，EXE 会去调用 DLL 的输出函数。但是也有可能在某个 DLL 中增加输出函数。

在输出表中，各个输出函数的名字必须升序排列，否则会报错。

## 消息循环

在 Windows 中应用程序的运行以消息机制为核心，每一个窗口都有一个窗口函数。那么也就是说窗口函数是程序的控制中心。

窗口函数被程序员称为 WndProc，它属于消息处理回调函数，用于对消息进行判断和处理。如果有消息产生，就会调用这个函数。它的主题由一系列 case 选项，用来编写这个回调函数需要处理的消息。

### 寻找消息循环

在创建窗口之前，程序必须调用 RegisterClass 注册一个窗口类。因为这个函数中有个参数指向了 WndProc 函数。

在点击菜单或者按钮的时候，Windows 会调用 SendMessage 函数给应用程序发送一个 WM_COMMAND 消息。当然如果点击了某个按钮之后弹出了对话框，也可以在对应的对话框函数上设断。

最后一种是利用 GetWindowLongA 函数。

### 菜单扩展

如果需要给程序增加菜单和按钮，就需要在 WndProc 里增加消息判断和事件代码。

那么需要扩展菜单功能，其实最简单的是找到case 跳转的汇编指令的位置(一般都是增加一些 cmp，je)。

### DLL扩展

上述的菜单扩展方法很容易出错，所以更可以实现一个 DLL 来实现一个特别的功能，这样将消息循环的代码扩展到 DLL 中就有更好的扩展性。一般的方法就是创建一个 DLL，然后在目标程序中直接调用这些接口。

当然一个更加灵活的方法是想办法将消息处理函数 WndProc 也扩展到 DLL 中，这样就相当于可以在原 WndProc 前先调用自己的处理函数了。