# 数据取证技术

这是最后一个内容，电子取证，就是指从计算机设备中获取信息，从而帮助进行调查等。对于一个处于关闭状态的计算机来说，硬盘就是最重要的取证对象；对于一个正在运行的计算机来说，因为内存中存储了当前运行的种种状态，所以内存的获取也是电子取证的一方面。其次还有许多诸如从注册表、文件中取证的技术。

## 硬盘

硬盘从实现的角度来说，可以分为传统的机械硬盘和基于闪存的 SSD。

如果对于某些计算机它不能或者不方便拆机，这时需要使用取证专用的 Linux 可启动光盘来获取信息。这里不使用 Windows PE 光盘是因为操作系统中可能会执行页交换等等操作影响取证的数据。使用该方法只要使用 Linux 自带的 dd 命令就可以来复制硬盘了，当然也可以用 dd 命令制作镜像。

如果计算机的拆解比较方便，那么最好的方法应该就是拆机，然后对硬盘进行处理。可以：

* 使用硬盘复制机复制硬盘
* 利用取证计算机复制硬盘

dd 镜像的好处在于研究和处理十分方便，但是其中的数据没有经过处理，占用空间太大，并且存储也是明文。但是后来有很多公司也推出了压缩和加密 dd 镜像的方法。

但是对于手机的话以上的方法可能并不是十分有效，因为手机的构造和电脑还是有些区别的。JTAG 方法是通过跳线的方法将手机置于调试状态下，从而获取手机芯片的数据。如果开启了 USB 调试，就可以尝试连接电脑实现一些操作了。

最后当我们获取了硬盘数据之后，我们需要固定其中的数据从而让它不被修改。使用 Hash 校验的方法就可以完成了。

### 分区和数据恢复

对于一台台式机，几乎每一个分区都会给用户添加一个盘符，而对于一个笔记本来说，可能一些分区是作为系统保留分区的，里面放着还原出厂设置的信息。

在移动设备中用户不能使用到的分区就更多了。

数据恢复的基本单位是分区，如果获取了硬盘的镜像，那么可以根据 MBR 或者 GPT 分区方案来判断分区。其实我们所谓的文件系统，说到底就是分区，两个东西是一回事。**我们通常会发现把一部 4GB 的电影复制到计算机硬盘中很长时间，但是删除却很快。**

在 Windows 上以 NTFS 文件系统为例，在创建分区时会将硬盘上一段连续的空间划分为两部分：索引区和数据区。那么数据在添加时需要 IO 写硬盘，同时需要在索引区添加文件的文件登记项。删除的时候释放文件登记项(打标记)，并且只对数据块做了标记，并没有影响数据，所以这就是为什么删除的数据依然能够被恢复。

这里常见的数据恢复工具包括了 WinHex、EasyRecovery、FinalData 等。

1. 源文件登记项被覆盖，源文件数据块没有影响。这种情况下不能使用普通的方法从文件登记项去寻找，那么只能通过每种文件不同的签名来寻找了(magic_number)。
2. 登记项没有影响，但是数据块被覆盖。如果全部被覆盖则无法被恢复，如果部分覆盖则可以分析剩余未被覆盖的内容。
3. 源文件登记项被覆盖，源文件数据也被覆盖。

根据上面的分析，可以得出移动设备的数据恢复不是非常靠谱，因为没有那么多资源供应来恢复。

这里的最后一个问题，用户可能会重新划分分区，那么在重新分区之后，原本分区的数据能找回来吗？答案是乐观的，因为重新分区和格式化只会破坏很少的数据，绝大部分的数据是不会被破坏的。最理想的方法是找原分区的第一个扇区。

## 内存

根据目前计算机的设计，程序要想执行必须要加载到内存中。在硬盘上的代码是可能被加密的，但是在内存中运行的时候肯定是裸露的一些代码。但是内存中的数据是易失去的，所以内存中的数据称为易灭失证据。

要进行内存分析，首先要获取内存镜像。如果这个系统是运行在虚拟机中的，那么虚拟机自然地会将内存映像文件保存在指定文件中，而在虚拟机中运行可能存在问题的系统并不会影响原系统中类似 Rootkit 的执行。

如果你分析的是笔记本电脑，并且当前处于开机状态，**就可以使用笔记本电脑的休眠文件获取物理内存的镜像**。休眠时系统会把物理内存备份到 C:\Hiberfil.sys 文件中，恢复时系统自动导入数据到物理内存。但是这一操作会破坏 c 盘中的可恢复数据。另外当系统出现崩溃时，比如蓝屏时，系统会生成崩溃转储文件，**这个相当于时系统被即时冻结的一个快照。**

当然也可以使用一些专门的工具，比如 Windows 下的 SafeImage 等等，但是这类工具并不会停止系统，而是抓取两个时间点之前的内存情况。

为了进行内存镜像的分析，比较有名的一个工具是 Volatility，它非常强大且有很好的扩展性。内存镜像分析的优势在于对抗 Rootkit 对系统的干扰，并且这种工具还能够在内存中进行数据恢复。

## 动态仿真技术

被检查的计算机一般不允许开机，因为绝大多数系统支持页交换，或者系统中一些组件会写临时文件来修改注册表和配置。动态仿真技术的目的就是启动这种被检查的计算机，而不破坏其中的潜在证据的软件和硬件。以前的操作是先复制出一块硬盘，把复制盘放入被检查的计算机中，来替换原来的硬盘。

### 硬件仿真

如果存在一种硬件插在硬盘和主板之间，把要写入硬盘的数据记录在这个硬件设备中。这种设备在现实中真的存在，比如 Logicube 公司的 Phantom。但是这种设备的接口非常有限，仅限于常见的 IDE 和 SATA。

### 软件仿真

因为本质上来说所有信息都存在于硬盘中，所以其实只需要有应哦按的信息，然后在其他取证计算机模拟其他硬件设备就可以了。**一般仿真工具都是基于 VMware**，把硬盘镜像放到虚拟机里，并用它启动虚拟机。

一般的步骤是新建虚拟机，把默认生成的硬盘删除，然后添加新的硬件。并且虚拟机软件一般可以制作虚拟机快照。如果出现蓝屏的话，则是缺少对应的驱动文件的原因，需要将最基本的驱动写入，然后一步一步使用 VMware Tools 驱动包安装。

## 注册表

注册表是 Windows 操作系统的配置数据库，它记录了大量重要的信息。无论是分析恶意软件还是电子取证，注册表都是一个非常重要的数据来源。从获取可靠信息方面来看，应该直接从处于关机状态的系统硬盘中解析注册表的相关数据。

注册表是由系统盘符中的若干 Hive 文件组成的。Hive 文件是类似数据库的文件，根据各个 Hive 文件的存储位置和 Hive 文件的格式，不仅可以从静态的硬盘或镜像文件中将注册表还原出来，甚至进行数据恢复。比如可以使用取证工具 SafeAnalyzer 查看注册表。

注册表中的每一个键在 Hive 文件都由一个键控制块表示，在 WinDbg 中查看它的结构。比如其中的 LastWrite 成员，记录了最后修改时间。当然其中也记录了类似 USB 设备的信息(HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Enum\USB)。包括其中也有记录 USB 设备的存储键。

## 文件格式

特定程序会依照特定格式打开或者解析目标文件，所以如果你通过逆向分析代码，你就能知道打开的文件的格式。

在软件中处理文件中的数据，通常是以数据块的形式存储，如果数据块中部分数据被删除，那么只会在这片数据中打上标记。比如大部分的数据库文件，微软的符合文档。

### 数据隐藏

有些情况下，可能有攻击者把文件中的一些数据隐藏了。那么一般使用某种文件的格式，就可以找出这些被隐藏的信息。比如 word 中隐藏的文字这个语句块会被标记为 vanish。

最后呢，讲一下可能出现的 NTFS 多数据流。比如说在 Windows 系统中文件名是不允许有 ‘：’ 的，因为这个字符专门用在 NTFS 多数据流中。NTFS 多数据流就是指在一个 NTFS 文件中可以存储多个文件。比如我们可以使用 notepad .\test1.docx:1.txt 命令来编辑一个看不到的数据。NTFS 多数据流的优点就是宿主文件和寄生文件的类型都不受限制。