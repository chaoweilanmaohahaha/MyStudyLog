# 静态分析技术

对于高级语言编写有两种形式，一种对应于编译成机器语言在 CPU 上执行，那么从机器语言返回到汇编语言，这称为**反汇编**；另一种是一边解释一边执行，这种语言叫做解释性语言，如果把解释后的程序再返回到高级语言结构，这叫做反编译。

静态分析的目的就是要通过反汇编、反编译的手法，分析程序的执行流程，了解各个模块的功能。

## 分析文件的类型

这一般是静态分析技术的第一步，就是要知道程序使用什么语言和什么编译器编译的，是否被加密加壳。

一般使用的是 PEID 这样的软件，它可以对文件用一个初步的认识。

## 反汇编引擎

安全软件和保护软件的开发过程中经常会用到汇编引擎和反汇编引擎，如果真的要使用这些反汇编引擎，也不需要自己手动来编写，一般网上有很多开源的反汇编引擎。比如反汇编引擎一般有 ODDisasm、BeaEngine、Udis86、Capstone，汇编引擎有 ODAssembler、Keystore、AsmJit。

其中在最后给出了这些引擎的一个对比：

* 性能上：Udis86 > BeaEngine > Capstone;
* 解码能力：Capstone > BeaEngine > Udis86
* 平台支持：Capstone > Udis86; Udis86 = BeaEngine
* x86扩展指令集：Capstone > Udis86; Udis86约等于BeaEngine。

## IDA Pro

在之前所说的使用了 PEiD 等测试工具分析了一下文件之后(主要分析是否加壳)。目前对程序进行反汇编的操作，最常用的工具就是 IDA Pro了。虽然之前提到的 OllyDbg 也有类似的功能，但是它偏重于动态的分析。

IDA Pro 之所以强大，一方面该工具支持的文件类型十分丰富，除了 PE 格式，还支持 DOS 等等的文件格式。一般而言我们分析 PE 文件，按照区块来装载它(代码块、数据块等等)。在 IDA 分析程序的过程中分为两个阶段，第一个阶段需要将程序中的代码和数据分开，分别标记函数并分析参数的调用；在第二个阶段识别文件的编译类型，装载对应的编译器特征文件，然后给各函数赋名。

IDA 的菜单栏中的 option 选项可以对 IDA 进行配置，或者说可以在 IDA 的文件夹中找到 cfg 子文件夹，修改其中的文件。具体的配置选项略过。

### IDA 窗口

* 反汇编窗口：有两种形式展示，一种是以普通文本的形式，一种是以图形视图的形式展现的，用户可以按下空格来切换。
* 导航栏：这一部分最重要的是存在一个加载地址空间的线性视图。
* 注释：可以在代码窗口的右边空白处单击右键，可以选择 Enter comment 或者是 Enter repeatable comment的选项。
* 提示窗口：一般处于界面下方的输出控制台。
* 字符串窗口：其中显示的都是从二进制文件中提取的字符串，双击某个字符串就可以跳转到该字符串的具体位置。
* 输入窗口：列出了可执行文件中调用的所有函数，双击该函数可以跳转到这个函数的地址处。

### IDA 使用方法

#### 交叉参考

使用这个技术可以知道指令代码的相互调用的关系。在某个调用的地址处按下 X 键，就可以查看交叉参考信息。(暂时不知道这个怎么用的)

#### 重命名

这个功能其中一个比较重要的功能之一，它可以使一些反汇编清单中默认赋予的功能更有意义，这样可以增加代码的可读性。右击选择 Rename，有以下选项可以选择：

* Local name：局部符号名的作用域仅限于当前函数
* In names list：构选这个选项，将有一个名称被添加到名称窗口中
* Public name：二进制文件输出的名称
* Autogenerated name：自动创建符号名
* Weak name：弱符号

#### 标签

这个和重命名不是一个东西，标签就是相当于在代码的某一个地方夹了一个书签，这样可以直接跳转到这个书签处。菜单栏中有 Jump -> Mark position。

#### 操作函数

IDA 允许手动干预创建、编辑、删除函数，这个功能暂时没有成功的使用过，不过新函数由不属于某个函数的现有指令创建。

#### 代码和数据转换

很多工具在进行反汇编的时候很可能无法正确区分数据和代码，IDA中很多数据和代码字节会被互相错认。我们可以在某个数据处按下 P 可以转换为子程序；可以在某段指令处按下 U，数据会重新以十六进制形式展现，按下 D 会在多种数据类型中切换。

#### 切换字符串

IDA 中支持所有的字符串格式，可以设置 ASCII string style 来设置对应的字符串格式。

#### 设置数组

IDA 有着比较强的数组聚合能力，如果说 IDA 没有识别一个数组的定义，那么可以在指向数组的位置选择菜单栏 Edit -> Array 或者 * 键，就可以打开数组排列调整窗口，设置后 IDA 就可以识别代码中定义的数组了。

#### 结构体

首先为了识别对应的结构体类型，那么 IDA 需要加载一些类型库，加载后代码中一些结构体类型自动识别出来。当然可以在 Structures 面板中看到已经有的结构体。

IDA 中支持整合数据为一个新的结构体，只要在 Structure 中按住 Insert 键，随后点击 Add Standard Structure。如果要处理结构体的数据，则需要在数据区选中对应的数据，然后使用 Edit -> Structs -> Struct var。最后需要在操作数类型中重新定义现有的数据，选择需要重新定义的数据，点击 Edit -> Operand types -> Offset -> Offset(Struct)，可以执行结构偏移功能。

#### 枚举类型

打开 Enumerations 面板，按下 Insert 可以插入一个新的枚举类型，而在这个新的枚举类型中按下 N 键新建一个新的枚举成员。最后将光标移动到需要重新定义的数据处然后执行 Edit -> Operand types -> Enum member 可以转换成指定的枚举成员。

#### 栈上变量

IDA 会自动认出哪些参数被放到了栈中，它可以给传递的哪些变量赋予有意义的而名字。

#### IDC 脚本

#### IDA 调试器

## 十六进制查看器

这个工具是直接以十六进制查看文件的利器，其中已知的是：

* HexWorkshop：提供了文件比较功能；
* WinHex：可以查看内存映像文件；
* Hiew：可以在汇编状态下修改代码；

