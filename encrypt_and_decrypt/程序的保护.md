# 软件保护技术

在这里主要考察其他一些可以保护程序的方法，除了我们看到的加密，加壳，还有一些技术可以运用到程序保护中。

## 防范算法求逆

在之前提到的注册算法中考虑到，如果可以逆向分析出注册算法，那么就可以破解整个程序。因此如果限制解密者的分析，就可以在一定程度上保护程序。

这个在保护技术中提过了，所以这里就不再展开了。这种保护建立在对映射函数算法的优化上。

### 堡垒战术

事实上 MD5 算法并不能直接用来制作注册机，因为它属于不可逆的函数，也就没有对应的反函数，那么一般而言使用 MD5 的方法如下：

1. 注册机 f 使得 R = f(U)。
2. 设 b = MD5(a)。
3. 令验证函数 F 为 F(U, R) = MD5[f'(R)-U+a]。

这里你可以发现，它并没有直接使用 MD5 来用作注册机，而是借助 MD5 函数，类似执行了一个数字签名的方法。

那么 RSA 算法它可以很好地运用到软件保护中，软件作者使用 R = U 的 d 次方模 n 作为注册机，然后使用 U = R 的 e 次方模 n 作为验证函数。通过 RSA 保护的软件可以看作一个堡垒，它十分难被破解。但是 RSA 算法的使用也可能带来一些问题：

* 如果使用了第三方代码，则这些公用代码中可能包含了漏洞
* 错误使用 RSA
* 伪随机数产生器的错误使用
* 使用 RSA 算法中的弱密钥

### 游击战术

游击战术就是将验证函数 F 分解成不同的子函数 F，然后尽可能将这些子函数隐藏到程序中。

这样只有通过了所有的子函数的验证才能最终通过验证，如果解密者不能找到所有的子函数，就无法对算法求逆，所以游击战术中的一个方案可以如下：

1. 将 R 切分多个段
2. 构造不同函数 f 算法，使得 Ri = fi(U)
3. Fi = fi‘

当然还有一个策略就是不让 U 和 R 形成一对一的关系，这样使得验证函数的个数具有不确定性。

但是可以想到，以上方案的弱点在于这些验证函数都会访问注册码，这样解密者只要跟踪注册码读取过程就能定位。那么针对这个问题，就需要对注册码进行大规模转移，**让注册码不同改变位置**。

## 抵抗静态分析

### 花指令

目前的反汇编算法主要包括**线性扫描算法**和**递归行进算法**。线性扫描会把模块中的每一条指令都反汇编成汇编指令，相当于尽可能当成代码，那么这样很难正确区分代码和数据。

递归行进算法是按照代码可能的执行顺序去反汇编，是对每条可能路径进行扫描。

所以综上所述，静态分析的弱点在于无法非常完美地区分代码和数据，花指令的想法就是在指令流中插入很多**垃圾数据**，干扰反汇编软件的判断。

而要迷惑递归行进的算法，需要想办法迷惑这类工具无法找到控制流转移的目的地址，这同样可以借助花指令来完成。

花指令的本质是使用了无用的数据，来干扰了反汇编工具判断指令的起始位置。

### SMC 技术

SMC：Self-Modifying Code。也就是在一段代码执行之前对它进行修改。那么策略就是将这样的代码片段藏在执行文件中，动态执行时进行解密。

### 信息隐藏

人机交互的实现形式，让攻击者可以根据用户选择后给出的提示信息来迅速找到核心代码。那么为了安全性，需要将这些提示信息隐藏起来。

比如提示信息中包含了一串字符串，那么需要将这个文字内容在程序中先隐藏起来，等到程序要使用这个字符串的时候再还原。

### 变形技术

其实变形技术更多的是在病毒软件中使用的。**病毒软件的特点就是有着多态、变形和混淆。**在现实的软件中，其实也可以尝试使用这种技术。

多态：将代码用某种算法编码，然后引擎生成一个充满干扰指令的解码器，方便在代码运行对代码解码。

变形：将一段代码重新编码，也就是将指令进行重构，这样可能让代码膨胀。

混淆：一般是指一些花指令和无用的代码，然后对已经混淆过的代码再次进行混淆。

> VX Heaven 上有很多病毒的资料，几乎所有病毒引擎都可以下载到。

## 完整性检验

完整性检验往往是针对攻击者恶意修改源程序的一种检查手段。

### 磁盘文件校验

CRC 校验码是比较常用的校验函数。那么可行的一种做法是，将目标文件计算一个 CRC 值，随后写入 PE 头部的空白处。

### 校验和

在 PE 可选映像头中就有一个 Checksum 字段，这个字段就保存了文件的校验和，但是这种保护手段并不保险，因为攻击者也可以修改这一字段。

### 内存校验

对于一些只读代码区，里面存放的是程序的代码，那么需要保证在运行的过程中这些代码不会被修改。

## 代码与数据的结合

最后，回到数据和代码的问题上，一般的程序中代码和数据都是分开的。那么如果将特征数据和代码中的一些关键部分相联系，则可以对这些数据起到保护作用。

这样的方法，可以避免使用爆破的手法，也就是跳过部分的判断分支来跳过对注册码的验证。你会发现就算跳过了验证，后面的代码也无法正常运行。

