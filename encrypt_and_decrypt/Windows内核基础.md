# Windows 内核

从 Linux 内核转到这里，其实设计都是差不多的。现代的操作系统基本分为应用层和内核层两个部分，那么对于 Windows 来说不例外。

## 内核

Windows 里面总有一种环的概念，比如说系统内核一般称为零环(Ring 0)，那么 CPU 设计者让CPU 可以运行在从内到外一共四个层面上。其中零环拥有最高权限，而 Ring 3 是最低执行权限。

本来设计者是想让设备驱动跑在 Ring 1 和 2 上的，但是为了工作方便，就直接合并到了零环中。

**用户层导出并且可以调用的函数接口都在 NTDLL.dll 中，它可以通过 API 或者其他子系统访问。**

### 内存

如果你的电脑是 32 位的，那么理论上支持最大的是 4GB 的虚拟内存空间。其中系统把内存分为 2GB 内核空间(0xffffffff 到 0x7fffffff)和 2GB 进程空间。

64 位机由于寻址空间支持的太大了，所以为了使用设计了空洞。

### 启动

简单叙述一下 Windows 的启动流程：

1. 计算机自检，BIOS 载入指令，然后硬件进行初始化。
2. 根据 CMOS 的设置，BIOS 加载启动盘，从主引导记录中引导代码载入内存，启动代码会搜索 MBR 中的分区表，将第一个扇区中的引导代码载入内存。引导代码检查当前的文件系统，然后寻找 ntldr 文件，然后启动它，至此后续工作交给 ntldr。
3. 设置内存模式，启动简单的文件系统。
4. 配置硬件设备
5. 加载内核和硬件抽象层，然后扫描读取安装的驱动程序，并且依次加载(注册表的 HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet)
6. 启动会话管理器 smss.exe，这是创建的第一个用户模式进程，它的功能是完善加载系统，创建虚拟内存页面。
7. 启动 winlogon 服务，支持用户登录。

上面提到的是之前 Windows 的启动流程，但是在新的系统上面使用了 UEFI 结合 GPT 的手段。UEFI 的出现就是替换 BIOS，它可以直接读取 FAT 分区中的文件。

### 通信

应用程序调用的 API 是被封装在某个 DLL 库中，而这个 DLL 库需要调用在 ntdll.dll 中更底层的函数。在 ntdll 中函数又是成对出现的，分别以 Nt 和 Zw 开头。

用户模式下，通过系统服务中的参数和栈中参数，由 SYSENTER 或者 syscall  指令进入内核态。

内核中存在一个 ntoskrnl.exe，存放了 SSDT 其中存放了对应的服务处理函数，即内核态的 Nt* 系列函数。

在这个过程中，应用层的命令和数据会被系统的 IO 管理器封装在一个叫做 IRP 的结构中。

内核主要由各种驱动组成，而这些驱动加载之后，会生成对应的设备对象，并尝试选择一个可以向应用程序提供可访问和打开的符号链接。而应用程序根据这个，就可以获得句柄，至此完成通信。

### 驱动

内核驱动在磁盘上是 .sys 文件，遵守 PE 格式标准，能够被系统加载执行。

> 这里先略去 Windows 加载驱动的过程

## 数据结构

内核对象是 Windows 内核中一种很重要的数据结构管理机制，有点类似 Linux 中的 kobject。一个内核对象由对象头和对象体组成，它一般分为三种：

* Dispatcher 对象
* IO 对象
* 其他对象，比如 EPROCESS 进程对象和 ETHREAD 线程对象。

### SSDT

系统服务描述符表，用于处理各个 API 操作请求。当发生中断时，调用的服务号会放入寄存器 EAX 中，而这个就是 SSDT 中的索引值。

SSDT 可以说时专门处理 Kernal32.dll 中的 API，而内核中存在 Shadow SSDT 是主要处理来自 User32.dll 和 GDI32.dll 中的系统调用。

### TEB

这个结构存在于应用层中，是线程环境块。进程中的每一个线程都有自己的 TEB，一个进程所有的 TEB 都存在于 0x7FFDE000 开始的线性空间内。

想要访问 TEB 可以调用 NtCurrentTeb 或者使用 FS 段寄存器来访问。

### PEB

进程环块，在用户地址空间中，在每个进程中存在，记录进程信息。TEB 中存在 PEB 的地址过。

可以看出进程对象和线程对象存在在内核空间中，它们分别拥有了一个指针，指向了应用空间中的 PEB 和 TEB 结构。

---

## 内核调试

在之前的逆向分析中提到过 WinDbg 调试器，这是内核调试的必备工具，而且 WinDbg 已经被集成到了 VS IDE 中了。

WinDbg 在本地调试中只能只能查看一些重要的系统数据结构，并不能通过下断点来调试。所以实现调试可以通过双机互连，而一般采用**虚拟机**来调试。

> 具体的搭建调试的方法在这里先略去