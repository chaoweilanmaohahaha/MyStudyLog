# 数据库概述

redis 数据库中存在客户端和服务器模式，redis 的数据库都保存在了服务器结构中，在服务器状态 redisServer 中有两个属性和数据库紧密相关：

```
struct redisServer {
	redisDB *db;
	int dbnum;
}
```

dbnum 记录服务器中有多少个数据库，也就是说 redis 服务器可以存放多个不同的数据库。db 就是一个数组。默认情况下每个 redis 客户端所制定的目标数据库是 0 号数据库，当然可以通过切换数据库来使用别的数据库，并且在客户端中也会记录目标数据库的信息。

## 键空间

redis 是一个**键值对**数据库，而所有的键值对保存在了这个 redisDB 中：

```
typedef struct redisDb {
	dict *dict;
}
```

redis 的键都是字符串对象，而值是五种基本类型中的一种。这个 dict 字典是数据实现的底层结构，在数据结构的介绍中也出现了，所以在这个数据库中的增删改查都是通过字典这个数据结构的基本操作完成的。

当我们往这个键空间中添加新的键值对时，就相当于在这个 dict 结构中新添加了一项，同理删除就是从这个 dict 结构中去除了一项。更新键操作就需要对 key 对应的 value 进行更新；查找键就更简单，只需要找到这个 key 就行。针对不同的值类型，会有不同的底层操作。

### 过期时间

在介绍对象的时候提到过一个 EXPIRE 命令，还有一个与它类似的 PEXPIRE 命令。这两个命令是以秒或者毫秒精度为数据库的某个键设置过期时间。当经过了这样一个过期时间后，redis 就会删除该键。在 redis 中一共有四个命令和设置过期时间有关：

* EXPIRE：以秒为单位设置过期时间；
* PEXPIRE：以毫秒为单位设置过期时间；
* EXPIREAT：以秒为单位设置过期的时间戳；
* PEXPIREAT：以毫秒为单位设置过期的时间戳；

但是总结上面的四个指令，会发现四个指令最根本的实现都是 PEXPIREAT，也就是所有的实现都会汇总成这个命令的实现。

过期时间不会直接保存在键值对中，而是有另一个字典：

```
struct redisDb {
	dict *expires;
}
```

expires 的键就是设置了过期时间的 key，值是一个时间戳，可以想象 PEXIREAT 的操作就是在这个 expires 中添加一项。当然还有相应的逆操作，就是删除过期时间 PERSISIT。

为了知道一个键还有多久会过期，TTL 和 PTTL 命令可以返回剩余的时间。

### 键删除策略

当到达过期时间戳，意味着键过期需要被删除。但是针对一个键要被删除，什么时候才能被删除呢？一般而言有三种不同的删除策略：

* 定时删除：通过使用定时器来规定什么时候删除键，但是这种方法对 CPU 时间并不太友好，因为这一行为会占用相当一部分的 CPU 时间。
* 惰性删除：只有在取键的时候才进行过期检查，所以意思是只有在必须删除的情况下才能删除键。但是这也有坏处，就是对于内存的使用是不友好的。
* 定期删除：这就是在定时删除和惰性删除取了一个折中。

那么在 Redis 中实际使用的是惰性删除和定期删除两种策略。

