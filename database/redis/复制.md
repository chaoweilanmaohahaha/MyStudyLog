# 复制

在集群中很常见主从服务器，让一个服务器去复制另一个服务器，被复制的服务器叫主服务器，而复制主服务器的称为从服务器，redis 中使用 SLAVEOF 命令来进行复制。复制的目的是为了保证双方的数据是一致的，这在集群中能够发挥比较大的作用。

## 旧版复制功能

redis 的复制功能包括同步和命令传播两个过程。

### 同步

一个客户端向从服务器发送了 SLAVEOF 命令，此时从服务器的状态需要更新到和主服务器一致的状态，这过程是由从服务器向主服务器发送 SYNC 命令完成的。当发送 SYNC 命令之后，主服务器执行 BGSAVE 命令并在后台生成 RDB 文件，并使用一个缓冲区记录所有写命令。主服务器会把 RDB 文件发给从服务器，让从服务器根据这个文件更新状态，随后主服务器还将记录在缓冲区中的写命令发送给从服务器，让从服务器执行这些写命令。

### 命令传播

要维持这种一致性，在每次主服务器被修改时，都需要将自己执行的那条写命令发送给从服务器执行，只有从服务器执行了相同的写命令才能让服务器之间恢复一致的状态。

---

旧版的复制功能存在明显的缺陷，如果该从服务器是在断线后进行复制的话，效率可以说是非常低了，因为它依旧要完成上述的所有 SYNC 操作，其实在断线之前从服务器里已经保有一些数据了。

---

## 新版复制功能

为了弥补耗费资源的 SYNC 操作，在 2.8 版本的 redis 以后使用了 PSYNC 操作替代原先的 SYNC，PSYNC 具有完整重同步和部分重同步两种方法。前者适用于初次复制，后者适用于断线复制。

### 部分重同步

着重看一下部分重同步时怎么做的。它需要保存三个属性：

* 主从服务器的复制偏移量；
* 主服务器的复制缓冲区
* 服务器运行 ID

复制双方都会维持一个复制偏移量，主服务器向从服务器传播 N 个字节的数据时就会给字节的复制偏移量加上 N；从服务器接收到 N 个字节数据就会给自己的复制偏移量加上 N。那么如果双方的复制偏移量是相同的，则状态就是一致的。现在假设其中一个从服务器断线了，则它的复制偏移量应该还会停留在上一次的位置，那么此时借助这个偏移量和下面的复制缓冲区就可以解决问题。

### 复制缓冲区

这是一个先进先出的队列，大小为 1MB。命令传播的过程中，服务器还会把命令写给复制缓冲区。那么此时当从服务器告知它目前的偏移量时，自然可以去缓冲区中查找，但是会遇到几种不同的情况：

* 如果偏移量内的数据存在，则复制；
* 如果不存在则进行完整重同步操作。

### 运行服务器 ID

主服务器会把自己的运行 ID 发给从服务器，这是为了查看断线后的从服务器在重连后所连接的服务器是否为原本复制的服务器了。

## 实现

在 redisServer 结构中有两个属性 masterhost 和 masterport，分别保存着主服务器的地址和端口。当执行 SLAVEOF 命令后从服务器根据命令所设置的 IP 地址和端口创建连向主服务器的套接字连接。

从服务器成为主服务器的客户端后第一件事就是发送 PING 命令检查连接状态，同时看是否能够正常处理请求(可能会超时或者错误)。当从服务器一旦收到 PONG 回复，则接下去决定是否进行身份验证，这个时看从服务器是否设置了 masterauth 选项。

当通过了验证之后，从服务器会给主服务器发送它的监听端口号，这个会存放在服务器客户但中的 slave_listening_port 中。接下去从服务器就可以给主服务器发送 PSYNC 命令进行同步操作和命令传播了。

## 心跳检测

命令传播阶段，从服务器会根据每秒一次的频率给主服务器发送 ACK 命令，这是为了检测网络连接状态，同时还可以查看命令是否丢失。

如果主服务器超过一秒没有收到从服务器 ACK 命令，则说明连接出现了问题。

有一种可能是由于网络延迟的问题，导致命令在半路失踪了，那么在 ACK 命令中会带有自己目前的复制偏移量。假设主服务器发现从服务器的复制偏移量明显的少了时，就会在复制缓冲区中发送少掉的那些数据(2.8 版本以后新增)。