# JAVA的内存和内存溢出

java和c/c++的一个很大的区别是，如果对于c/c++熟的都知道内存的开辟有借有还，但是java在虚拟机管理下有着自动回收的机制，因此当使用new创建了一个对象后不用担心释放的问题，也不用担心内存的泄露问题。但是如果一旦出现了问题，却又很难找到问题出现的位置。

### JAVA虚拟机管理内存

**程序计数器（PCR）**

这个组件是一个较小的内存块，它是当前线程中所执行的字节码的行号指示器，字节码解释器在工作时使用其中的值来选取下一条指令。而对于多线程来说，每一个线程都需要维护自己独有的程序计数器，在线程切换时能够恢复现场。

**JAVA虚拟机栈**

这个组件也是线程独有的，它的生命周期和线程的生命周期是一样的。每个方法在执行时会创建一个栈帧，其中包括局部变量表，操作数帧，动态链接，方法接口等。所谓局部变量表就是包含了在编译时能够知道的各种数据类型，这张表所需要的内存空间在编译期间完成分配。

当一个线程申请的栈深度过大时，虚拟机会抛出StackOverflowError异常。

**本地方法栈**

和java虚拟机栈类似，只不过一个是处理了java方法也就是字节码服务，一个是处理了Native方法。（native方法就是java调用非java语言的接口）

**JAVA堆**

Java堆是虚拟机中管理内存最大的一块，并且它是被所有线程共用的一块区域，它的生命周期始于整个虚拟机建立时。可以说在java中所有对象和数组的内存空间都是在堆上分配的。这个区域也是垃圾收集器管理的主要区域。注意一个有意思的事情，java堆的内存区域可以在物理上并不连续，但是只要在逻辑上连续就可以了。

**方法区**

这个组件也和各个线程共享，它用来存储虚拟机加载的类，常量，静态变量等数据。这个区域很少进行内存回收，因此有说法认为这个区域时永久代。

**运行时常量池**

这个区域是方法区的一部分，用于存放各种字面量和符号引用。

**直接内存**

在JDK1.4中粗线了一种可以使用native函数库来直接分配堆外内存的方法，存放在java堆中的DirectByteBuffer对象中。这样直接内存不会受到java堆大小的限制，但是受到本机内存的限制。

### HotSpot虚拟机中的对象

**对象的创建**

在编写java代码时，创建一个对象只是使用new关键字就可以解决的问题。但是在内存中是如何解决问题的呢？

当虚拟机遇到了一条new指令，此时会检查这个指令中的参数是否能在常量池中定位到一个类的符号引用，并且需要检查这个符号引用代表的类是否已经被加载。接下去就是给新的对象分配内存，大小在类加载完成后就可以确定。（这里需要考虑两种情况即内存规整和不规整的情况下的实现；这里还有一个问题就是分配的过程中是否会存在线程安全的问题）此后虚拟机会将分配到的内存空间初始化为全0值，这也就是为什么对象一些实例中的值在未定义的情况下是0值。然后对一个对象进行对应的设置，包括这个对象属于那个类的实例，如何找到某个类的元数据，哈希值等等。

**对象的布局**

一个对象在内存中可以分为三片区域：对象头、实例数据和对齐填充。对象头部分存储的一些数据就是在对象创建过程中填充的，其中一部分是对象自身的运行数据包括哈希码，锁状态等；另一部分保存了类型指针，它指向了类元数据的指针。如果对象是java数组，则对象头中还需要保存对象的长度，java虚拟机通过java对象的元数据确定java对象大小。接下去是实例数据部分，这部分是真正存储的信息，包括了程序代码中定义各类的字段内容，无论是否是继承的数据。HotSpot中将宽度相同的字段分配在一起。对齐填充起到占位符的作用，对象的起始地址必须8字节的整数倍，也就是说对象的大小必须是8字节的整数倍，因此实例数据没对齐就必须填充。

**对象的访问**

Java程序需要通过栈上的reference数据来操作堆上的具体对象。那么这个reference类型来找具体的对象实例一般通过两个方法来实现：一时通过句柄访问，Java堆中会划分出一块内存，来作为句柄池，reference中存放句柄地址，而句柄包含了对象实例数据和类型数据；二是直接指针访问，那么Java堆中就要保存响应的实例数据，同时reference中存储的就是直接的对象地址。

**除了程序计数器外，其他的组件均会存在内存溢出的异常问题，这时需要注意的。**

**如果是JAVA堆出现异常，则在OOM后自然会跟上Java heap space;**

**如果是虚拟机栈和本地方法栈出现异常时，一般由于栈的使用问题都会抛出StackOverflow异常，而多线程的操作会导致OOM操作**

**如果方法区和常量池发生溢出，则会跟上提示信息PermGen space的提示信息**

**如果时直接内存溢出，则会有一个明显的特征就是Heap Dump文件中不回看见明显的异常**

