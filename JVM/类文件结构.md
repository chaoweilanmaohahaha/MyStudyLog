# 类文件结构

各种不同平台的虚拟机与所有平台都统一使用字节码作为程序存储格式。实现语言无关性的基础就是虚拟机和字节码。也就是说JAVA虚拟机不和任何的语言进行绑定，只和.class文件格式绑定。但是注意的是.class文件格式只是一种格式，任何的语言都可以通过它自己的编译器将语言编译为.class格式的文件然后交付给java虚拟机。

class文件是一组以8位字节作为基础的二进制流。在class文件格式中采用的是一种类似C语言结构体的伪结构存储，这种数据结构中只有两种数据类型：无符号数和表。无符号数是基本数据类型，可以用来表示数字、索引、数量值等；表则由多个无符号数和其他的表构成的符合数据结构，而且在命名上都是以_info结尾。**要注意的是class文件没有分隔符，因此所有内容的顺序和结构都是严格要求的。**

#### 魔数

class文件的开始4个字节称为魔数，这是用来判断是否这是一个能被虚拟机接受的class文件，这和很多类型的文件在开头使用魔数的方法是一样的。跟在魔数后面的四个字节分别代表了Java的次版本号和主版本号。

#### 常量池

紧接着存放的是常量池入口。常量池中常量的数量是无法固定的，因此在常量池的入口处就要存放所含常量的数量，也就是一个计数器。常量池一般存放着两种类型的变量：字面量和符号引用。字面量就是在Java中要使用的常量；而符号引用涉及类和接口，字段和方法。有意思的是虚拟机加载class文件是动态加载的，也就是说class文件中不会保存方法字段的最终内存布局，需要在虚拟机运行时加载。

常量表中每一项都是一个表，表中使用tag来标记类型。

#### 访问标志

紧接着是访问标志，也就是标识类和接口层的的访问信息，说明这个class是类还是接口，是否为public类型，是否定义abstract。

#### 类索引、父类和接口

这些字段的目的就是为了确定类的继承关系。

#### 字段表

描述接口或者类中申明的变量。其中包括类级变量和实例级变量。那么包括了作用域、static、可变性、并发可见性、序列化、字段类型、名称。其中有一个描述符字段：

* 全限名称：就是使用/连接的完整名称。
* 简单名称：没有类型和参数修饰的方法或者字段名称
* 描述符：描述字段数据类型，参数列表和返回值。

#### 方法表

和字段表几乎一模一样，可以描述出方法的访问标志、名称索引、描述符和属性。

#### 属性表

属性表中并不需要严格的顺序、长度和内容，里面包含虚拟机能够认识的属性。包括code属性（存储代码）、Exceptions属性（列举抛出的异常）、SourceFile属性（源文件名称）、ConstantValue属性（静态变量属性）、InnerClasses属性（内部类和宿主关联）等。

最后说一下Java虚拟机执行字节码使用的指令和汇编指令十分类似，由一个字节标识，而且大多数操作不包含操作数。大多数的指令已经包含了操作所对应的数据类型了。