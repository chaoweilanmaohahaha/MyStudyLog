# ICMP协议

icmp协议：internet control message protocol 网络控制信息协议

作用：这个协议是被封装在IP报文中的。IP协议是一个尽力而为的协议，它的可靠程度很难保证，而ICMP协议往往配合IP协议，传递网络传输中出现的一些状况的信息，包括错误信息和一些其他类型的信息，使得主机对发送的报文状况有所了解。

###### 有个注意点说在前面，ICMP错误信息的应用场景有一些特殊的地方，它无法应用于返回一些广播包的控制信息，这样做会导致广播风暴的出现。

报文格式：

![icmp1](../img/icmp1.png)

ICMP协议的type域控制了这个报文的类型，而code域则说明这是该种类型报文中的第几种类型的报文，例如图中是最经典的ping request报文，它的type和code域分别为8和0。checksum域是对icmp协议做校验，和ip报文中的checksum域类似。

###### ICMP错误信息中，在生成错误负载的时候必须包含至少8字节的IP报文内容



###### 谈谈几种比较经典的ICMP协议：

###### 1、子网掩码获取和回复

这个通常用于一个无磁盘的系统要获取它的子网掩码时，需要广播它的ICMP请求。

###### 2、时间戳获取和回复

向其他主机获取时间戳

###### 3、端口不可达



------

#### ping 程序

这个程序的目的一般是为了判断某个主机是否存在或者是否可达。可以看到在上面截取的icmp报文中还有两个域值得关注，一个是identifier（识别号），一个是sequence num（序列号），在ping程序中要求reply中要包含域request中相同的域内信息，这是为了区分多个ping程序的原因。在Unix系统中identifier域内的信息就是ping程序的进程号。

特别需要注意的是，如果我们是在ping hostname时，会出现第一行例如hostname （IP号），这样的字样，然后会间隔一段时间显示ping的信息，那是因为DNS在解析域名。

在局域网中使用ping指令时，你有时又会发现第一条ping命令的time会比其他稍微长一点，那有可能是因为需要arp解析。

icmp -R 这个命令的作用是在发送icmp request包中的option域中加入一个list，当途中每过一个路由器，该路由器将它的出口地址填入表中，然后直到最后一个主机时，将它的入口地址填入表中之后，将该表信息填入reply包中的option域内发还。（测试中未成功）

还存在一种时间戳ping程序，但是也未成功，和上述-R命令类似，只不过将option部分换成了时间戳。



#### traceroute 程序