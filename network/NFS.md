# NFS

NFS协议：NetWork File System(网络文件系统)

这也是一个可以从客户端拿到文件的一个方法，它需要使用到交Sun PRC的一个东西，帮助他完成取文件的过程。

## Sun RPC

还记得之前的文件传输都是怎么做的吗？都是客户端起一个连接，然后调用某个函数来传输数据；服务端响应这个连接，并在某个特定端口接收这个数据。但是Sun RPC不同，客户端所谓的写操作，就是调用服务端的函数。一个具体的步骤是这样：

1. 客户端会调用远程调用，这会在本地调用函数使用RPC包生成，这些函数可以叫做客户桩，它们回将调用过程中需要的参数打包到网络信息中然后传给服务器；
2. 服务桩收到该网络信息后使用这些数据调用服务器上的进程；
3. 服务器上的进程返回值后，服务桩会把数据打包到一个网络信息中，然后传回客户端；
4. 客户桩收到信息后返回给客户端进程。

讲一下具体的RPC报文格式，假设它存在于UDP包中：

transactionID标识号，指定了某一对请求响应；call调用域为两个数，0表示调用1表示回应；RPC版本号默认为2；接下去三个域分别为程序号，程序版本号，过程号，它们表示某一个特殊的过程被调用了。credentials证书用来识别客户端的身份，包含了用户ID和组ID；verifier是用来提供安全保障的，它使用DES加密；最后一部分指的是过程参数，内容的形式和调用的过程有关。回复报文中有些许不同，在call字段下多了一个状态字段，如果是0表示信息已经收到；然后再verifier下面也多了一个字段，如果是0表示成功。**注意RPC中的信息都使用了XDR编码方式。**

### 端口映射

有一个非常有意思的事情，在服务器端运行的远程调用所使用的端口并不是熟知的端口，而是需要分配的端口，那么必须要有一种方法可以让客户端知道应该将信息发往何处，因此有了端口映射。这里服务器要通过RPC调用注册它们，同时客户端也通过RPC来查询相关映射。因此当RPC服务程序开启时，会有如下步骤：

1. 端口映射打开，开始监听端口111；
2. 当RPC服务器程序启动，它会为每一个它支持的程序建立一个TCP或者UDP连接，然后注册所有的程序；
3. 当一个客户端程序启动时，它会先调用端口映射函数来获取指定程序的端口号；
4. 进行调用

## NFS 协议

NFS和FTP有着本质的区别，注意FTP的目的其实是拿到了文件的一个复制，但是NFS其实是直接进入了某个文件或者文件系统，这就意味着如果一个客户在本地进入了某个文件就相当于进入了NFS系统的文件中。

一个用户进程来说进入某个文件是透明的，但是内核会决定是否是一个本地文件还是NFS文件，如果是NFS文件，则通过RPC调用来获取文件内容，而再传输过程中其实传输的是一个叫做文件句柄的东西。

#### 挂载协议

客户端必须使用NFS挂载协议来挂载一个服务器文件系统，这一步是在客户端初始化的时候做的。挂载进程在端口映射完成后开启，它同样需要完成端口映射的步骤，那么首先客户端需要找到这个挂载进程的端口号，然后与这个挂载进程通信来挂载一个文件系统。**NFS协议是无状态的，并且需要注意的是有些命令是可重复执行的，有些则不能。**