# 计算机系统结构

做一个知识总结，说不定以后还会用到

## 流水线

就是把每个功能分成多个子过程并行进行，这就是流水线技术。每个子过程称为段，段数构成流水线的深度。

### 相关与冲突

有一个经典的RISC流水线模型，分别包含了5个时钟周期：取指令周期IF、指令译码/读寄存器周期ID、执行有效地址周期EX、存储器访问分支完成周期MEM、写回周期WB。

相关说明两条指令之间有依赖关系，一共有三种类型：

* 数据相关：j使用i产生的结果
* 名相关
  * 反相关：j写i读的单元
  * 输出相关：j写i写的单元
* 控制相关

冲突是指某种事件使得下一条指令不能在指定时钟周期开始执行：

* 结构冲突：硬件资源重叠 (流水线气泡)
* 数据冲突：前后出现数据依赖(数据定向技术，停顿，指令调度)
  * 写后读冲突
  * 写后写冲突(输出相关)
  * 读后写冲突(反相关)
* 控制冲突：分支情况改变PC(分支预测、延迟分支)

## 向量处理机

该机器特别善于向量运算，能够尽可能发挥一共有三种处理方式：横向处理方式、纵向处理方式、纵横处理方式。

### 在向量机提高性能的技术

* 设置多个功能部件
* 使用链接技术
* 使用分段开采技术
* 使用多处理机系统

## 指令并行性开发

保持的两个最关键属性是：数据流（数据实际流动）和异常行为

### 动态指令调度

思想是不一定让指令按序流出，通过一定的修改后的流水线可以是乱序的，同样完成也可以是乱序完成。

**硬件技术**：

* 记分牌动态调度方法
* Tomasulo算法
* 动态分支预测技术
  * 使用分支历史表
  * 使用分支目标缓冲器
  * 使用基于硬件的前瞻执行技术

使用多指令流出技术

使用超长指令字技术

使用超流水线处理机

**软件技术（编译器）**：

* 循环展开
* 跨越基本块的指令调度
  * 全局指令调度
  * 踪迹调度
  * 超块调度
* 静态多指令流出
* 显示并行指令计算
  * 非绑定分支
  * 谓词执行
  * 前瞻执行
* 更多的循环级并行
  * 循环携带相关
  * 存储器别名分析
  * 数据相关分析
* 软流水

## 存储系统

存储系统追求的目标：容量大、速度快、价格低。为了达到这样一个较为均衡的情形，所以采用层级结构的存储器。

一般大多数计算机都采用Cache、主存和磁盘存储器构成的三级存储系统，这样一般拆解为“cache-主存”结构和“主存-辅存”结构。

Cache-主存层次中首先考虑4个问题：

* 块调入高一层的存储器时，放在哪个位置上？
* 当所要访问的块在高一层的存储器中，应该如何查找？
* 当发生不命中并且高一层的存储器已经满了，怎么替换？
* 当进行写访问，只有哪些操作？

下面回答问题：

1. 内存地址要进行转换，转换为cache地址。主存块映射到cache中有全相联映像、直接映像和组相联映像。

2. 考虑组相联影响，主存地址分为标识、索引、块内偏移。cache中存在一个只存目录项的标识存储器，所以有两种方法：

   1. 用相联存储器来判断（标识）
   2. 用单体多字按地址访问的存储器和比较器来实现

3. * 随机法
   * 先进先出法
   * 最近最少使用
     * 堆栈法
     * 比较对法

4. 写策略：

   * 写直达法
   * 写回法

   写不命中时调块选择：

   * 按写分配法
   * 不按写分配法

**降低Cache不命中率的方法：**

* 降低不命中率
* 减少不命中开销
* 减少命中时间

应对方法：

1. 关于不命中有三种：强制性不命中、容量不命中、冲突不命中

   * 增加Cache块大小
   * 增加Cache容量
   * 提高相联度
   * 伪相联Cache
   * 硬件预取
   * 编译器控制的预取
   * 编译优化
     * 数据重组
     * 内外循环交换
     * 分块！！

   * 牺牲Cache

2. * 采用两级Cache
   * 读不命中优先于写
   * 写缓冲合并
   * 请求字处理技术
   * 非阻塞Cache技术

3. * 使用简单的、容量小
   * 虚拟Cache
     * 虚拟索引-物理标识方法
   * Cache访问的流水化
   * 踪迹Cache

**并行主存系统：**能在一个访存周期内能并行访问多个存储字的存储器。

* 单体多字存储器：存储器能够在每个存储周期读出m个CPU字
* 多体交叉存储器：多个单体存储体构成
  * 处理避免存储体冲突

**虚拟存储器：**分为段式和页式。使用专门的告诉缓冲器TLB，用来存放近期经常使用的页表项。TLB中存放着一些标志位，标识和页内偏移。CPU给出的虚拟地址分为虚页号(标识号)和页内位移。虚拟存储器技术设置在主存-辅存之间。

## IO系统

反映存储外设可靠性的参数：可靠性、可用性和可信性。

### 廉价磁盘冗余阵列(RAID)

* RAID0：非冗余磁盘阵列
* RAID1：镜像磁盘
* RAID2：存储器式的磁盘阵列，使用海明码进行校验
* RAID3：位交叉奇偶校验磁盘阵列，磁盘保存数据位，冗余盘保存奇偶校验位
* RAID4：块交叉奇偶校验磁盘阵列，磁盘保存数据块，冗余盘保存奇偶校验位
* RAID5：块交叉分布奇偶校验磁盘阵列，奇偶校验信息保存在数据块中
* RAID6：P+Q双校验磁盘阵列

### 总线

设计考虑：总线宽度，数据总线宽度，传输块大小，主设备数量，分离事务，定时方式。

### 通道

使用通道的目的是在进行IO读写时解放CPU，则通道的使用过程是：

1. 用户程序使用访管指令进入管理程序，然后由管理程序编制一个通道程序，并启动通道；
2. 通道处理机执行通道程序，完成指定的数据传输工作；
3. 通道程序结束后向CPU发送中断请求。

通道类型：

* 字节多路通道
* 选择通道
* 数组多路通道

### DMA

* 物理DMA技术
* 虚拟DMA技术

设计时要注意的问题是IO和Cache数据的一致性问题。

## 互连网络

互连网络是一种有特定拓扑结构和控制方式构成的网络，实现计算机系统中各个节点之间的互相连接。

### 互连函数

互连网络中是一连串的输入结点和输出结点之间的连接关系，那么互连函数是表示这个输入和输出端口连接关系的映射。互连函数包括：

* 恒等函数
* 交换函数：Cube_i
* 均匀洗牌函数：循环置换
* 碟式函数：最高位和最低位交换
* 反序位函数：各位颠倒
* 移位函数：向下或者向上错开k位
* PM2I函数：加或者减2的i次方位

### 静态互连网络

各个结点的连接通路是固定的

* 线性阵列：一条线
* 环、带弦环：带弦环指环中多几条链路
* 循环移数网络：环中每个距离为2的整数幂的结点之间有一条链路
* 树状、星型
* 胖树状
* 网络状、环网状
* 超立方体
* 带环立方体
* k元n-立方体网络

### 动态互连网络

由开关构成、可按运行程序的要求动态改变连接状态的网络

* 总线网络：总线一个时候只能有一个节点进行通信

* 交叉开关网络

* 多级互连网络

  开关控制模式：级控制、单元控制、部分级控制

  * 多级立方体网络
  * Omega网络

### 消息传递机制

消息寻径方式：

* 线路交换
* 存储转发
* 虚拟直通：可不缓存
* 虫蚀方式：片传递

流控制策略：

包冲突（选中了输入缓存区以及通道）：

* 包暂存
* 阻塞包
* 丢弃包
* 绕道

一对一通信寻径：

* 确定性寻径：已经预先设定好的起点和终点
* 自适应寻径：根据网络情况选择路径
  * X-Y寻径
  * E-cube寻径

多计算机网络中可能的通信模式：

* 单播
* 选播
* 广播
* 会议：多对多

## 多处理机

**集中式共享存储器结构**：各个处理器共享一个集中式的物理处理器，因为只有单一的主存，并且这个主存相对于各个处理器之间的关系是对称的，也被称为对称式共享存储器多处理机，这种系统结构也称为UMA。

**分布式存储器多处理机**：存储器再物理上是分布的，每个节点由处理器及其cache、存储器、IO以及互连网络口组成。

**统一共享逻辑空间进行编址DSM**：也被称为分布式共享存储器系统，同样也可以称为NUMA计算机。

**独立地址空间进行编址**：不同节点的地址空间是相互独立的。

**共享存储通信机制**：处理器之间的通信是通过用load和store指令对相同存储器地址进行读写操作来实现的。

**消息传递通信机制**：处理器之间是通过发送消息来进行通信的，这些消息请求进行某些操作或者传送数据。

### 实现多处理器Cache一致性

* 目录式协议：物理存储器中数据块的共享状态被保存再一个称为目录的地方。
  * 全映像目录
  * 有限映像目录
  * 链式目录
* 监听式协议：cache需要访问存储器时，把请求放到总线上广播，其他Cache控制器通过监听总线来判断它们是否有总线请求的数据块。

数据一致性：

* 写作废协议：在写入操作时，将其他的cache中的副本作废。
* 写更新协议：在写入操作时，其他cache用新数据对其中的副本进行更新。



