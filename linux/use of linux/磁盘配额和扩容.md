# 磁盘配额与扩容

## 磁盘配额

磁盘配额的意思就是**限制使用额度**，那么一般而言限制额度有下面几种情形：

* 限制某一个用户组所能使用的最大磁盘额度；
* 限制某一个用户所能使用的最大磁盘额度；
* 限制某一个目录的最大磁盘额度；

在看如何进行磁盘配额之前，先看一下磁盘配额在系统上的一些限制，比如说对于 ext3 文件系统而言，它只能堆整个文件系统进行限额，并且要保证内核一定支持磁盘配额。最后就是这个磁盘配额只能被用在一般用户上。

磁盘配额到底能够做到什么？其实它一共有如下功能：

* 分别针对用户、用户组或者个别目录限额；
* 限制 inode 的数量，即管理用户建立的文件数量；
* 限制 block 的使用量：管理用户的磁盘容量；
* 实施软限制和硬限制，其中硬限制指一定不能超过的限制值；软限制值允许在一定时间内超过，但是超过宽限时间，该限制就会升级为硬限制。

### 命令

对于 xfs 文件系统，它有 xfs_quota 这个命令，该命令也可以用来查看系统上文件系统的数据。比如你需要查看 /home 下对于用户的限制情况，可以：

```
xfs_quota -x -c "report -ubih" /home
```

此时假设需要堆某个用户或者用户组进行限额，可以使用如下命令：

```
xfs_quota -x -c "limit [-ug] b[soft/hard]=N i[soft/hard]=N name"
```

其中 u 选项代表用户，g 选项代表用户组， soft 和 hard 代表软限制和硬限制，b 代表在 block 上限制，i 代表在 inode 上限制，name 代表需要被限制的用户和用户组的名字。

如果此时要限制的目录本身，而不是用户的使用情况，则此时需要先规范目录，需要在 /etc/projects 和 /etc/projid 下填入识别码和目录标识。比如：

```
echo "11:/home/a" >> /etc/projects
echo "myproject:11" >> /etc/projid
```

此时就能对目录进行配额了，比如：

```
xfs_quoto -x -c "limit -p b[soft/hard]=N i[soft/hard]=N name"
```

最后如果不想要进行配额设置了，使用 disable 能够暂时取消限制，但是系统其实依然在计算配额情况，使用 enable 就能启动。off 选项是完全关闭配额，只有重新挂载后才能再次启动，而只有在 off 的情况下，才能使用remove 移除配额限制设置。

## 磁盘阵列

RAID 技术的目的是将多个较小的磁盘整合成一个较大的磁盘针列，一般有如下几种：

* RAID0：交错存放数据，磁盘大小最好一样，否则会有瓶颈。如果某个磁盘出现问题数据就损坏；
* RAID1：完整备份，磁盘数量中有一半的磁盘用作备份，容量减少了 50%
* RAID1 + 0 或 RAID 0 + 1: 上面两种的混合
* RAID5：其中每一个磁盘会额外加入一个奇偶校验位，实际使用的磁盘容量是 N-1，仅支持 1 块磁盘损坏；
* RAID6：RAID5 的扩展，支持 2 块磁盘损坏；
* 热备份：使用一个磁盘暂时不加入 RAID 针列，当针列中某一个磁盘宕了，可以将这个空余磁盘直接加入其中不需要插拔替换。

RAID 保证的是可靠性，以及在一定程度上加快 IO，组成一个容量更大的磁盘。最好的 RAID 是磁盘针列卡来完成磁盘针列功能，但是针列卡贵，所以就发展出利用软件来模拟磁盘针列的功能。

在系统上设置磁盘针列的方法很简单：

```
mdadm --create /dev/md[0-9] --auto=yes --level[015] --chunk=Nm --raid-devices=N --spare-devices=N /dev/vad{}
```

简单的说，生成 /dev/md[0--9] 的分区，然后设置多少个分区直接合并成 RAID，spare-device 是空余磁盘，用来做热备份。chunk 代表的是数据写入磁盘的大小。

```
mdadm --manage /dev/md[0-9] [--add] [--remove] [--fail]
```

这个命令是用来管理 RAID 的，那么它可以将某一块添加入分区，也可以移除一块，也可以让某一块正在工作的分区失效。

最后讲讲如何关闭这个 RAID。这个步骤比较麻烦，简单的说需要清除所有配置文件中涉及 RAID 的信息，最重要的是还需要覆盖 RAID 的 metadata 和 XFS 的 superblock信息。一般需要使用类似一下语句：

```
dd if=/dev/zero of=/dev/md0 bs=1M count=50
```

## 逻辑卷

一般而言，分区的大小一开始就已经划分了，但是假设我需要使用更大的空间了，怎么对其扩容呢？一种最简单的办法就是使用一个大的硬盘，然后将数据拷贝过去随后挂载到系统中，但是这样未免很麻烦。

逻辑卷 LVM 就是一个用来调整文件系统容量的工具，它可以整合多个物理分区变成一个逻辑上的磁盘，随后在这个逻辑磁盘上新增或者删除分区。在正式接触 LVM 之前，先看几个 LVM 中会碰到的概念：

* 物理卷 PV：这时 LVM 最底层的结构，是由实际分区转换过来的；
* 卷组 VG：就是将 PV 整合后生成的大磁盘。
* 物理扩展块 PE：这时 LVM 最小的存储单位，类似于文件系统的 block，是将 VG 切分了。
* 逻辑卷 LV：VG 切分 LV，LV 中带有 PE。LV 可以被格式化，这类似于分区。

所以如果说要创建一个逻辑卷，需要以下步骤：

1. gdisk 进行分区
2. pvcreate 创建物理卷
3. vgcreate 创建卷组
4. lvcreate 创建逻辑卷
5. mkfs 格式化

LVM 最主要的用处在于可以弹性调整文件系统，它的写入可以是线性写入的，也可以是交替写入的。

那么 LVM 怎么做扩容呢？它需要满足以下三个条件：

* VG 有剩余容量：因为需要放大 LV 所以 VG 肯定要有足够的容量，否则需要添加设备；
* LV 有剩余容量：可以将没有用到的 PE 加入其中；
* 文件系统阶段需要放大：这一步最重要。

使用 lvresize，你可以将那些没用到的 PE 加入到 LV 中，从而扩大 LV 的容量，但是从文件系统层面，它并没有扩大，因为文件系统中的元数据并没有被修改，所以在扩容后需要使用类似 xfs_growfs 来最终扩容。

LVM 最后一个很强大的功能是生成 LV 的快照，这个方便 LV 的备份和恢复。它所作的是将在数据修改后，能够将原始数据搬到快照取，但是其他没修改的区域和文件系统共享，因此快照区和被快照的 LV 必须在同一个 VG 上。注意恢复的数据量是不能够高于快照区的实际容量的。

如果你要关闭 LVM 则所作的正好和创建过程是相反的步骤，其中要注意需要卸载文件系统，并且使用 vgchange 让 vg 失效。