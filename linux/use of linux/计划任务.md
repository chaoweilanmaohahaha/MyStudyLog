# 计划任务

计划任务代表这个任务其实还没发生，但是未来某个时刻会去做，这样的任务仍然可以分成多种类别。比如周期性需要做的，比如临时需要在未来某个时刻需要做的，这两种情况就在 Linux 中对应两个计划任务的种类。

在 Linux 中可以把每隔一定周期需要办的事项称为**例行性任务**，把在做完这一次之后就没有的事项称为**突发性任务**。在 Linux 系统中已经存在了很多例行性工作了，比如处理和分析日志的任务、建立 locate 的数据库、RPM 软件日志文件的建立、删除缓存等。

## 突发性任务

在系统中执行突发性任务时，系统中需要负责这类任务的服务，这就是 atd 服务。它不是所有 Linux 发行版默认启动的。

突发性任务是由 at 这个命令来建立的。事实上 at 命令会将所要运行的任务以文本文件的方式写入 /var/spool/at/ 目录内。**但是并不是所有的用户都能执行 at 这个计划任务**，因为黑客能够劫持系统，使用 at 执行相关任务。因此在系统中利用了 /etc/at.allow 和 /etc/at.deny 两个文件实现了对用户的限制，这样执行 at 的过程变成：

* 如果有 /etc/at.allow，写在这个文件中的用户才能使用 at，其他用户不能使用；
* 如果有 /etc/at.deny，写在这个文件中的用户不能使用 at，其他用户可以使用；
* 如果两者都不存在，只有 root 可以使用 at 这个命令；

at 命令最重要的是指定任务的时间，然后就会进入 at shell 输入要执行的任务。at 任务会独立于 bash 环境，所以指定了 at 任务后就可以立刻脱机了。

但是使用 at 有一个小问题，如果系统恰好在持续做忙碌的作业，则 at 任务就会增加系统的负载。在 Linux 中有 batch 命令，**这个命令的目的是在 CPU 的任务负载小于 0.8 的时候才执行工作任务**。

## 例行性任务

前面提到在系统中其实存在很多系统维护的例行任务，这些使用 cron 这个系统服务控制的。当然用户也可以设计自己的执行计划任务，这使用 crontab。

有必要说一下对于 crontab 这个命令也存在 /etc/cron.allow 和 /etc/cron.deny，这两个文件和 at 中的作用十分类似。crontab 会将建立的任务记录到 /var/spool/cron 中，**并且以账号来作为判断依据**。当然如果你想判断是否在这个例行性任务中出了问题，可以查找一下 /var/log/cron 这个文件。一条例行性任务的格式应该如此：

```
分 时 日 月 周 命令串
```

其中在非命令串中还可以使用一些特殊字符，代表一些特殊含义。

那如果要编辑系统级别的例行性任务呢？这时并不能使用 crontab 来修改，而是直接通过修改 /etc/crontab，因为 cron 服务最低检测限制是分钟级别的，所有每一分钟后都会去读取一遍配置文件，所以理论上修改完就会执行。

/etc/crontab 中会包含以下：

```
PATH=
MAILTO= # 执行错误后会把消息发送给谁

分 时 日 月 周 身份 命令
```

就比用户的多一个身份，因为要明确执行的任务是属于哪个用户的。除了这个配置文件，crond 服务还会去读取 /etc/cron.d/ 下的任务。其实这个里面的配置文件和 /etc/crontab 很类似，不过有点文件中有点特别的任务：

```
* * * * * root run-parts /etc/cron.hourly
```

run-parts 会大约在 5 分钟内执行后面目录中所有的执行文件，所以其实如果你想每个小时的任务，就放到 /etc/cron.hourly 下，当然也有每月每年的。

---

这里做一个总结了，我们可以怎么设置例行性任务：

* 用户个人使用 crontab -e
* 系统维护可以使用 /etc/crontab
* 自己开发的软件可以在 cron.d 下放入自己的任务
* 如果固定每小时、每日和每周执行的特别任务，可以放到对应的目录下。

那么里面暂时要注意的问题是，周的设置和日月的设置不能并存。

---

## 唤醒停机期间的任务

假设现在设置了一个计划任务，但是在执行时停机了，按照 at 和 cron 来看，它就直接会被略过了。但是假设这个时候还是希望这个任务被执行，是不是只能由用户自己手动执行一次呢？

在 Linux 中有 anacron 命令，它也每小时被 crond 执行一次，它的目的是检测相关的计划任务有没有被执行。anacron 的实现要使用到时间记录文件。

以每日的任务为例，对于 anacron 会检测到这个任务天数为 1 天，那么它会从 cron.daily 取出最近一次执行 anacron 的时间戳，如果比对后时间超过了 1 天就会执行命令。执行的时间根据在配置中设置的延迟时间。而注意的是它执行的是 cron.daily 目录下所有的可执行文件。**所以这里有个隐含条件就是，如果你把需要做的内容都存放在执行的执行目录下(cron.daily)，那么它默认会被唤醒执行**。