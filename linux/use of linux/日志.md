# 日志与相关操作

日志能够记录系统的活动，一般就是何时、何地、什么人、干了什么。那么更详细地说就是**系统的哪个进程在什么时候做了什么**。

那么目前系统里面的日志记录了一些什么呢？首先硬件的检测过程会被记录盗日志内容中，其次网络服务的各种问题通常也会被写入到特殊的日志文件中，硬件的启动和检测也会记录到日志当中，内核的检测过程所产生的信息、系统运行过程中出现的错误信息以及登录者的登录信息都会被记录到日志文件当中。由于日志文件有这么多有关系统的信息，因此一般日志文件只允许 root 读取。

在 centos 中和日志有关的服务主要是 rsyslog.service 和 systemd-journald.service，有关的程序还包括 logrotate。

## 格式

日志文件的格式一般有如下：

* 事件发生的日期与时间；
* 发生此事件的主机名；
* 启动此事件的服务名称；
* 该信息的实际内容

比如说：

```
Aug 17 18:38:06 study login: ROOT LOGIN ON tty1
```

为什么一定要加主机名这一项呢？因为假设本机作为一台日志服务器能够收集其他主机的日志，则这一栏目就是不同主机的主机名了。

## rsyslog

rsyslog 的最大目的是处理日志，并把它们存储到合适的地方。其实讲道理它就是处理 Linux 内核提供的 syslog 产生的数据。但是如果只是将该日志数据存储到一个文件中未免也太过杂乱，因此 rsyslog 可以帮助分门别类来存储。

rsyslog 的配置文件是 /etc/rsyslog.conf，这个文件规定给了：

* 服务
* 等级
* 记录位置

比如说：

```
mail.info -/var/log/maillog
```

其中：

* 服务主要是 Linux 的 syslog 规定本身规定的一些服务信息，一共有 23 种
* 等级包括 8 个不同的严重等级，比如 info 属于最轻的，只是记录一些基本信息；代号越是小代表越是严重。这里有个细节，就是服务与等级之间的符号，其实一共有三种，代表了记录的内容的范围，一般而言 . 代表比后面还严重的等级都要被记录下来；.= 代表严格等于，.! 代表除此之外；
* 记录位置除了普通的文件外，还可以选择打印机、用户或者远程主机等。

有可能有的时候你会看到在记录位置前有个 -，这个代表了产生信息太多，因此先存储在速度较块的内存缓冲区中，等到数据量够大才一次性写入磁盘。

### 安全

日志文件既然这么重要，那么假设有人恶意增加数据或者删除数据，不是使得记录的东西就不准了吗。**确实包括有的时候假设一不小心打开了某个日志文件然后保存了，该文件就无法被继续记录，除非重启 rsyslog 服务**。

那么怎么保证日志文件不能被删除，**就要用到前面的 chattr 设置 a 这个属性**了。但是实际上 root 也能够去掉这个 a 属性。所有对于 root 而言加上该标识并没有什么用。

### 日志服务器

你当然可以选择将一些数据发送到比如打印机上或者用户，不过假设现在的需求是要监视网络内的其他主机的日志情况，将其中一台作为服务器，其他主机作为客户端。配置服务器只需要在配置文件中打开监听的端口和使用的协议，配置客户端时只需要将发送的目标改成服务器的 IP 地址就可以了。

## logrotate

现在已经将日志记录到了文件中了，但是假设始终记录到一个文件中，该文件将变得十分冗长，最后会影响读写的速度和性能。logrotate 的目的就是轮询日志，对日志文件进行备份和切分的功能，它会在规定事件内进行轮询操作，所以它被 cron 服务所控制。

同样 logrotate 主要依靠它的控制文件来操作，那么对于一个文件，主要有以下属性：

* 文件名：要被轮询的绝对路径名
* 参数：轮询的参数会被 {} 包起来，比如默认间隔时间、保留文件个数、文件名选项等
* 执行脚本：在启动 logrotate 之前或者之后需要执行的功能

更详细的可以直接查看 logrotate 的文件，并且自己尝试修改。

## journald

rsyslog 是需要服务启动后才开始记录日志的，但是其实系统在该服务启动起来之前已经有一些执行信息了，这些信息可以通过 systemd-journald 来记录。它是一个将日志信息记录在内存中的服务，因此它所记录的日志信息只包含本次登录的信息。假设你想在控制台上查看，可以使用 journalctl 命令。

假设你想保存 journal 日志，可以到 /var/log 下新建一个文件保存，不过其实这样做有一些冗余，因为毕竟有 rsyslog 在工作。

当然你也可以通过 logger 命令自定义记录一些日志信息。

## 日志分析

最后谈一谈如何分析日志，其实在 Linux 中的很多命令都已经对一些日志信息进行了解析，比如 last、lastlog、dmesg 等。那么如果想要更详细具体分析日志，可以使用 logwatch 这个程序，它会把它的分析结果定时以邮件的形式发送到用户邮箱中。

当然如果你有一定的编程能力，自己开发一个相关的日志分析工具也是可以的。

