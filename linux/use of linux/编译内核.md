# 内核的编译

内核是整个操作系统最底层的，它负责着整个硬件的驱动，提供了各种系统所需的功能。如果你想要让计算机完成某项功能，就必须让内核支持。内核中包含了什么呢？这个文件包含了驱动主机的**各项硬件测试程序和驱动模块**。

内核通常被命名为 /boot/vmlinuz-xxx，一台主机上可以拥有多个内核文件，但是启动的时候仅能选择一个来加载。内核的许多部分都已经模块化了，那么内核也是通过源代码编译得来的。如果用户需要一些最难硬件的驱动模块的话，**理论上应该由各大厂商提供驱动程序**。

为什么要编译内核？内核编译的重点在于你想要系统做些什么，内核是可以随时、随各人喜好修改的，当然对于一般用户而言一般没必要编译内核。那么真正需要编译内核的原因可能是：

* 需要添加新功能
* 原本内核太大太臃肿
* 需要与硬件配合提高稳定性
* 有一些其他的需求

所以综上，如果不是有其他的需求，编译内核最主要目的还是让系统变得更加稳定。

既然要重新编译内核文件，那么哪里可以拿到内核的源代码呢？

* 可以使用原 Linux 发行版提供的内核源代码文件
* 可以从网上获取最新的稳定内核源代码
* 可以利用网上提供的 patch 文件升级内核源代码(每一次内核的发布除了完整的内核文件外还会附带与前一版本的差异文件)

## 安装

一个内核文件压缩包里会有很多目录，一般我们将一个内核压缩包解压到 /usr/src/kernels 目录下。

首先我们会清理一下内核源代码下面的残留文件，有两种方法：命令 `make mrproper` 会清除目标文件和配置文件，当然它也会把内核功能选择文件清除，所以一般这个命令只在第一次编译时做；如果只是想清除目标文件，则使用 `make clean`。

既然要个性化地设置内核功能，用户必须在安装之前做出选择。在 /boot 目录下一般会存在一个 config 开头的文件，这个文件是**内核功能选择列表文件**。选择的过程中就是要依靠这个文件，在源代码目录下生成一个 .config 的隐藏文件，生成这个文件的方法有很多，命令包括：

```
make menuconfig
make oldconfig
make xconfig
make gconfig
make config
```

上面的命令都有不同的功能，功能选择的宗旨在于**尽可能保持内核小而优良，剩下的功能能够编译成为模块**。那么内核的功能选项主要有：

* General Setup：基础程序交互、内核版本说明等
* loadable module + block layer：支持动态的内核模块
* CPU 类型与功能
* 电源管理功能
* 总线选项
* 编译后执行文件格式
* 内核的网络功能
* 各个设备的驱动程序
* 文件系统的支持
* 内核开发、信息安全和密码应用
* 虚拟化和函数库

当你完成了上述的选择后保存选项就完成了编译内核前最重要的步骤。接着就可以进行编译了，主要的方法有：

```
make -j 4 vmLinux // 未经压缩的内核
make -j 4 modules // 仅内核模块
make -j 4 bzImage // 经压缩的内核
make -j 4 all 
```

一般只要进行第二个和第三个就行，最后如果成功了就会在源代码目录下的 /boot/arch/.../产生 bzImage 文件。

在安装模块时可能会遇到的问题在于和前一个版本的模块冲突，那么解决方法要么是修改就模块的目录名，或者是在 General Setup 中修改 Local version。

来到最后的内核安装阶段，一般我们既需要保留旧版本，又要安装新版本，那么内核理论上存放在 /boot 下以 vmlinuz 开头。同时还需要给该内核制作一个 initramfs 才可以。最后使用 grub2-mkconfig 添加启动选项就可以重启来查看新安装的内核了。

## 单一模块编译

无论是内核的模块还是比如新的硬件驱动程序所需要的驱动模块，它们都和内核的功能有很大的依赖关系，所以编译它们难免需要内核的源代码以及内核的头文件等，因此除了编译时除了需要 gcc 等编译器，还需要 kernel-devel 这个软件。

一般对于单一模块的编译有两种情况：

* 忘记在默认内核中选择某个功能
* 需要一个硬件驱动模块

后者一般需要你自行下载模块的源代码，进行编译然后放置在正确的地方，就是内核目录中，然后使用 depmod 建立依赖关系后，未来就能使用 modprobe 来直接使用。

前者需要到内核功能选择步骤中，将某个功能选中成为模块，随后直接对该模块代码进行编译产生模块文件，最后执行 depmod -a 命令就能够使用了。