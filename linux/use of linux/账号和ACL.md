# Linux 账号与 ACL

一般使用 Linux 的时候肯定都是需要使用密码和用户名登录到系统的，但是其实对于系统而言它不管你的用户名和密码，因为它根本不认识。那么对于系统而言它是通过 UID 来唯一标识一个用户的，而每一个用户的密码和用户名只是被存放在了 /etc/passwd 中。

每个登陆的用户至少会被分配到两个 ID，一个 UID 和一个 GID，通过这两个 ID 可以到 /etc/passwd 和 /etc/group 中找到对应的用户，**否则你会发现 ls 的结果中用户和用户组会出现数字**。

那么登录 Linux 系统时，对于账号验证环节它都做了什么呢？

1. 先查找 /etc/passwd 中是否有输入的账号，如果有就把 UID 和 GID 读出来，同时把家目录和 shell 也读出；
2. 去 /etc/shadow 中找到对应的 UID 检验密码；
3. 进入 shell。

和用户账号有关的文件大体有下面几个：

## 账号文件

### /etc/passwd

这个文件每一行是一个账号，**里面有很多账号属于系统账号**。它的每一行包括了：

* 账号名称
* 密码：这里一般是一个 x，老版文件会把密码放在这，但是由于 passwd 人人都能读取，所以为了安全现在不再放在这里；
* UID：其中 0 代表系统管理员；1~999 代表系统账号，一般是不可登录的；1000~ 代表可登录账号；
* GID 
* 说明：这个一般用来解释账号意义
* 家目录
* shell

### /etc/shadow

这个文件存放了密码，如果仔细看的话会发现，它每一行有 9 个字段：

* 账号名称
* 密码：编码后的密码，因为固定的算法产生的密码是固定的，所以修改了这个字段后就会使其失效；
* 最近修改密码时间：这个是记录了从 1970.1.1 开始的天数；
* 密码不可被修改的天数：代表修改后经过多少天密码才能再次被修改，一般为 0  代表随时可以修改；
* 密码需要被修改的天数：意思是你必须要再改天数内重置密码，否则密码将会过期，一般是 99999 代表没有必要一直修改；
* 密码需要修改前的警告天数：意思是再过这么多天，密码将要过期；
* 密码过期后的账号宽限天数：如果密码过期了你仍然可以登录，但是此时系统在改期限内会强制要求你修改密码；
* 账号失效日期：天数，此账号规定改日期后，账号将无法使用，一般出现在一些收费服务中。
* 保留

那么很有可能会出现忘记密码的事情，假设是一般用户忘记了密码，则只要让系统管理员来帮忙；如果是管理员忘记了密码，那只需要进入单人维护模式就可以了。

### /etc/group

该文件每一行代表一个用户组，其中一共有如下字段：

* 组名
* 用户组密码：这个通常给用户管理员使用；
* GID
* 该用户组支持的账号名称；

### /etc/gshadow

这个文件的最大功能就是建立用户组管理员(帮助 root 管理用户组)，该文件每一行同样是四个字段：

* 组名
* 密码
* 用户管理员账号
* 加入到该用户组的账号

那么理论上在系统中每一个用户都可以加入多个用户组，在执行任务的时候怎么判断某个用户到底是哪个用户组呢？每一个用户在创建的时候都有一个**初始用户组**，也就是 passwd 的第四栏，当用户一登陆系统就有该用户组的权限。可以用 groups 命令查看一个账号的用户组，其中第一个输出的代表了该用户的**有效用户组**。那么有效用户组就和当前作业时应该用的用户组有关了。

如果需要将有效用户组切换为别的，可以使用 newgrp 命令，此时必须时已经支持的用户组，并且**修改后就是用另一个 shell 来提供功能了！因此只有使用 exit 才能切换回原本的环境中。**

## 管理

管理无非要做一些增删和修改的功能，那么这里就分相关的命令和配置文件两个部分来看：

### 配置文件

* /etc/default/useradd：useradd 的默认数据文件
* /etc/logindefs：一些账号的基准数据参考

### 命令

* useadd：简单的添加账号，但是实际有很多选项。而默认情况下会做：

  * 在 /etc/passwd 中添加一行账号数据；
  * 在 /etc/shadow 中添加一行密码数据；
  * 在 /etc/group 中添加一行组数据；
  * 在 /home 下建立家目录

  首先新建的账号在 shadow 中是不会立刻有密码的，需要另外设置；并且对于系统默认的账号是不会新建一个家目录的。

* passwd：使用 useradd 后建立的账号在默认情况下是被锁定的。此时需要使用 passwd 来设置密码。新的 passwd 还支持从 stdin 创建密码。同时也支持锁定和解锁账号。

* chage：显示密码参数，并且可以修改

* usemod：修改创建账户时的一些参数；

* userdel：删除账号，使用这个的时候要确定该账户在主机上不会使用任何数据了；

* id：查看某个用户的账户 ID 信息

* finger：查看用户相关信息，这个不是默认安装的程序

* chfn：配合上面的 finger 的程序，用来修改相关信息；

* chsh：修改自己的 shell

* groupadd：添加一个组

* groupmod：修改 group 创建的相关参数

* groupdel：删除某个用户组，不过需要确认没有用户使用该用户组作为**初始用户组**；

* gpasswd：建立用户组管理员，它可以管理账户加入或者被移除某个用户组。

## ACL

Linux 中传统的权限只对拥有者、群组和其他人指定了，但是无法对某个特定的用户等进行更细的权限控制，这就是 ACL 所要做的事。它可以针对单一用户、单一文件或者目录进行 r、w、x 的权限设置。

目前 ACL 已经默认加入到了常见的 Linux 文件系统中。使用 getfacl 可以看到某个文件的 acl 设置信息。如果需要设置某个文件的 acl 权限，则使用 setfacl 命令。

## 身份切换

一般而言，只有在真正要设置一些系统环境时，才会使用 root 权限来管理系统，这为了系统的安全，同时许多类似 ssh 的程序，是不允许直接使用 root 登录的，这会影响到系统的安全性。

但是有时有些操作确实只有拿到了 root 权限后才能操作，这时就要使用身份切换。

* su：这个是最简单的身份切换命令，注意如果 su 后面直接跟上某个用户，则以非登录 shell 方式切换了身份，所以很多变量不会修改，只有使用 su - 或者 su -l 修改身份时才会更改环境。但是 su 切换身份必须知道目标用户的密码，这在很多情况下是不能做到的；

* sudo：并非所有人都能执行 sudo，仅有规范到 /etc/sudoers 内的用户才能执行 sudo。sudo 一开始系统默认仅有 root 可以执行 sudo，执行 sudo 的流程：

  * 执行 sudo 时会去 /etc/sudoers 中查找用户是否有执行 sudo 的权限；
  * 输入用户自己的密码
  * 执行 sudo 的后续命令
  * 如果切换的身份和执行着身份相同，则不需要密码；

  那么如果需要加入到 sudoer 的行列，则需要 root 去修改文件，一般使用 visudo 命令就能进行修改，sudoers 文件中内容大致如下：

  > root  ALL=(ALL) ALL

  其中包括：

  * 用户账号
  * 登录来源
  * 可切换的身份：在括号中的内容
  * 可执行的命令

  所以这个文件的修改可以做到让用户免密切换身份，限制命令操作等等。

  最后提到的时其实 sudo 自身有时间间隔的设置，默认两次操作间隔不超过 5 min，就不需要再重复输入密码(安全和方便兼顾)。

## PAM

有一些用户是天生无法登录的，代表着这个用户是无法使用 shell 来登录系统，但是不代表它不能使用该系统的资源，它们的 shell 使用的就是 /sbin/nologin。

但是其实在一个系统中有很多场景要登录，使用多个认证系统可能导致密码不同步的验证问题。如果要解决这个问题，在 linux 中引入了 PAM 的机制。PAM 是一套 API，它提供了一连串的验证机制，过程是用户将验证阶段的需求告知 PAM 后，PAM 就能返回用户验证的结果。

它是一套验证的机制，又可以提供其他程序调用，所以无论什么程序都可以使用 PAM 来验证，具体的语法和调用方式这里不展开，使用到的时候再详细说明。

## 账号交互

最后谈一下你在系统上如何和其他账号的用户进行交互，第一步肯定是要知道当前系统到底有哪些账号登录了。使用 w 或者 who 命令能够进行查询。

write 命令可以给某个用户发送信息，不过这会中断那个用户的作业。所以配置 mesg 就能设置是否接收信息。 wall 命令用给用户们进行广播。

mail 命令的目的是给某个用户发送邮件，最后邮件会放置再 /var/spool/mail 中对应用户的邮箱中，使用 mail 特定的命令格式可以查看接收到的邮件。

---

最后补充提及一些命令，有兴趣可以使用使用，这些命令都是用来检查家目录或者密码数据有没有问题，比如 pwck、pwconv、pwunconv、chpasswd。