## PeriScope: An Effective Probing and Fuzzing Framework for the Hardware-OS Boundary

大多数的内核攻击都在系统调用边界上，但是还有另外一种不需要借助系统调用的方法，就是通过攻破外部设备固件来进行攻击，因为许多驱动程序都是跑在内核空间上的。本篇文章着眼于攻击者从设备驱动入手，因此这是一个探测分析设备驱动的框架。

攻击的方法就是远程设置这个设备，然后使这个设备生成一些指定的输出，这些输出再去触发驱动程序的一个漏洞。作者设计了一个perifuzz的工具用来取得MMIO和DMA的读权限，然后修改读到的值。它不仅可以修改读取不同的地址的值，还能修改读取同一地址的值。

首先必须知道外部设备和操作系统怎么进行交互：

1. 中断：处理这个的方法是：外设会在某一跟中断线上发送一个中断请求，CPU会响应请求并且关闭这条中断线上的所有中断，此时CPU进入这个中断处理例程。注意中断处理历程的顶部和尾部之分。
2. MMIO：CPU会开辟一篇内核空间的虚拟地址来和外设进行映射，这样CPU可以使用平常一样的读写方式进行操作。
3. DMA：允许外设直接访问物理地址空间。

现在系统会使用一种叫做IOMMU的组件限制外设能够访问的物理地址，它是将外设所看到的虚拟地址转换为物理地址。



periscope的做法是在驱动程序这一端来关注数据流动的信息，因此它会在内核缺页例程机制上装上钩子函数，具体做法如下：

1. 当设备驱动程序建立了一个MMIO或者DMA映射，它会自动检测到并且进行注册；
2. 分析者需要指定某一个映射来进行监视。
3. 它将映射中的某一页标记为不在内核的页表中。
4. 当cpu访问这个被标记的页，则触发缺页。