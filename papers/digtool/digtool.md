# Digtool

本篇文章是对闭源操作系统windows系统进行漏洞挖掘，使用的技术是虚拟化监视。

关于漏洞检测的方法大致分为两类：路径探索和漏洞识别。像使用的AFL这种工具是典型的路径探索。漏洞识别就是记录探测到的路径上的异常情况。这篇文章主要针对的是漏洞识别技术。目前与市场上的大多数用户漏洞识别的工具不同的是，市场上的工具针对的是开源的操作系统，依赖的是其中的具体实现。所以作者想到了使用虚拟技术，它就可以支持多种操作系统。但是市面上使用该技术的系统又只是针对单一的漏洞。对于闭源的操作系统的难点在于我们无法在编译时插入检测的代码，当然也不能直接改写内核代码。本文针对如下四种漏洞：

UNPROBE：对于一个输入缓冲区，不去校验用户指针，着就会导致类似非法地址指向，非法读写。

TOCTTOU：我认为就是所谓的double-fetch，从一片内存区域抓取两次数据，通常是检查一次用户指针，然后再用。

UAF：使用了系统中已经释放的区域

OOB：我认为就是缓冲区溢出，也就是进入了超出分配堆栈的边界。

## overview

整体的digtool涉及到三个部分：用户空间、内核空间和虚拟机

虚拟机就是将操作系统和硬件分离了，它也可以被称为VMM，虚拟监视器，可以访问磁盘内存等硬件设备，介于操作系统和硬件之间。虚拟机的目的是监视虚拟地址的入口，需要有一种机制从外部跟踪内存入口。使用SPT影子页表来进行监视。这个是他们自己开发的，一共有三个部分：VMM infrastructure、interface detection、memory detection。这个VMM infrastructure做一些初始化的工作，需要获取硬件环境和OS版本，interface detection 监视系统调用执行时从用户程序中输入的参数。这个监视可以量身定制。memory detection 监视内核内存使用情况。它可以设置监视区域以及设置监视目标。

内核空间主要做的事设置需要监视的区域，这需要和虚拟机进行交互，并且可以截获内核函数。实现是一个中间件，这个中间件在interface detection的作用是记录了所有的事件日志。这样可以用log analyzer分析日志。对于memory detection通过hook一些指定的与内存有关的函数来指定j监视内存区域。如果漏洞被找到，中间件记录并打断客户机OS通过单步调试或者软件中断，客户机操作系统会连接到一个debug工具。

用户层有一个loader，一个fuzzer和一个log analyzer，loader用来激活虚拟机，开启用户进程，然后触发fuzzer，然后将探测到的执行路径记录在log analyzer中。

