# Towards Safer Smart Contracts: A Sequence Learning Approach to Detecting Security Threats 

## Background

目前大部分的分析智能合约的工具都是建立在符号执行上的，但是符号执行需要十分复杂的分析过程，它需要预先决定好的分支的触发，并且如果执行的分支越是深入，搜索时间就越是长。

比如说 MAIAN 这个工具，它确实是一个使用符号执行技术的一款很不错的分析工具，但是它的缺点就在于由于分析时间的限制和搜索能力的限制，并无法进入更深的分支触发漏洞。

那么作者的想法就是使用机器学习的方法。因为最近有很多的研究都是有关将机器学习运用到智能合约漏洞发现上的。那么这篇文章也是使用机器学习的手段。

## Preparation

### 漏洞类型

作者在这篇文章中分析的漏洞类型具有局限性，因为其实这个模型需要借助 MAIAN 的分析结果，所以确实能够检测的漏洞有限。

* 自杀式的合约：这份合同可以被任何的地址调用。调用suicide前未检查调用者身份/授权用户列表可被修改。
* 浪子合约：转账的过程中使得这份交易的币最后没有进入对方账户
* 贪婪合约：不释放交易中的币

### LSTM(长短期记忆网络)

要简单这个模型首先还是得知道一下它的背景。

神经网络在处理序列信息，比如语音、视频这种，很难处理。因为传统神经网络并没有办法使用前面的事件对后面的事件分类。

针对这个问题提出了 RNN(循环神经网络)，它允许每一次输出的信息都在网络中继续循环。这样 RNN 可以广泛运用于语音识别、翻译等等场景中。但是 RNN 自身还是有些漏洞，比如长依赖问题、梯度消失和爆炸。

LSTM 就是为了弥补 RNN 的一些漏洞。LSTM 和 RNN 不同的是，它在单个网络里的复杂程度要比 RNN 高。

LSTM 使用门来控制细胞状态，分别是忘记门、输入门、输出门。忘记门决定需要丢弃哪些信息；输入门控制需要添加哪些新的信息；输出门控制那些信息需要更新为下一步要使用的状态信息。

## Details

这是一个二分类的问题，输入的是给定的程序的操作码序列，输出是判断该程序是否为有害的。

### 预处理

该工具的输入是操作码。什么是操作码，它时一系列的数据，就是将源程序进行解释后用来表示被执行操作的类型。可以理解为类似汇编。

为了进行有监督训练，我们必须要带标记的数据，那么在本文中的做法是将合约的**字节码**交给 MAIAN，通过这个过程既可以知道它的分类结果，又可以解析出相应的**操作码**，这些信息都是要保存下来的。

### 输入形式

本文中为了将这个操作码输入到分类器中，作者选择使用独热编码，也就是一位编码。但是一位编码过于简单不能代表操作码的性质，并且长度受限于操作码数。所以作者改善了这种方法，采用**代码向量**。

代码向量能够发现序列中的潜在关系，并且能够压缩整体输入，避免向量随着指令数增多而增多。

### 数据

作者从 Google BigQuery 的一个以太网数据集中获取了 920179 个合约。

在这些合约中，就像上面说的，要给这些样本进行标记，那么除了这个，还需要剔除一些错判的例子，这个使用 Nikolic 工具。

最后作者在去除了不合法的和重复的操作码序列后，选择了 8640 个反例和 416944 个正例。

> 作者认为操作码反映了智能合约的主要执行逻辑，所以使用操作码序列就可以用来检测漏洞。

细节问题，这里假设了 LSTM 操作码流最长的 1600，这个是通过统计结果得出的。

注意现在还有一个问题，那就是反例和正例不平衡啊，所以需要进行一个重采样。作者随机采样了正例，并使用了 SMOTE 方法对反例重采样。最后获得了 620000 个智能合约。

## Evaluation

为了验证这个模型的性能，作者用了**混淆矩阵、AUC ROC 分数**。一共计算了它的测试准确度， recall 分数、精确得分、F1 分数和 AUC 分数。

> 在这里面作者强调了一点，就是对 MAIAN 的依赖。

并且为了测试该模型对误判的样本的检测效果，作者发现该模型可以检测大部分的误判情况。

最后作者还分析了该工具和 MAIAN 的执行时间对比，根据操作码的长度，发现该工具几乎是一个常数执行时间，而 MAIAN 花费的时间很长。

## Limitation

1. 这里简单的认为操作码序列可以反映合约的逻辑，但是这种判断很多情况下失去了代码中的数据和控制的依赖。
2. 漏洞的种类被限制了。
3. 只能判断合约是否有漏洞，但是无法更具体分析合约的漏洞。